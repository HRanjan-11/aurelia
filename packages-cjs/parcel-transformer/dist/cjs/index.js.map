{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import { Transformer } from '@parcel/plugin';\nimport SourceMap from '@parcel/source-map';\nimport { IOptionalPreprocessOptions, preprocess, preprocessOptions } from '@aurelia/plugin-conventions';\n// eslint-disable-next-line import/no-nodejs-modules\nimport { relative, extname } from 'path';\n\nexport default new Transformer({\n  async loadConfig({config}) {\n    try {\n      const conf = await config.getConfig([], {packageKey: 'aurelia'});\n      return conf ? conf.contents : {};\n    } catch (e) {\n      return {};\n    }\n  },\n  async transform({asset, config, options}) {\n    // parcel conventions puts app's index.html inside src/ folder.\n    if (asset.filePath.endsWith('src/index.html')) return [asset];\n\n    const auOptions = preprocessOptions({\n      ...config as IOptionalPreprocessOptions,\n      stringModuleWrap: (id: string) => `bundle-text:${id}`\n    });\n    // after html template is compiled to js, parcel will apply full js transformers chain,\n    // we need to skip them here, then parcel will apply the rest standard js chain.\n    if (asset.type === 'js' && auOptions.templateExtensions.includes(extname(asset.filePath))) {\n      return [asset];\n    }\n\n    const source = await asset.getCode();\n    const result = preprocess(\n      {\n        path: relative(options.projectRoot, asset.filePath.slice()),\n        contents: source\n      },\n      auOptions\n    );\n\n    if (!result) {\n      return [asset];\n    }\n\n    asset.setCode(result.code);\n    const map = new SourceMap();\n    map.addVLQMap(result.map);\n    asset.setMap(map);\n\n    if (auOptions.templateExtensions.includes(`.${asset.type}`)) {\n      asset.type = 'js';\n    }\n\n    // Return the asset\n    return [asset];\n  }\n});\n"],"names":["Transformer","preprocessOptions","extname","preprocess","relative","SourceMap"],"mappings":";;;;;;;;;;;;;AAMA,YAAe,IAAIA,kBAAW,CAAC;IAC7B,MAAM,UAAU,CAAC,EAAC,MAAM,EAAC;QACvB,IAAI;YACF,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,SAAS,CAAC,EAAE,EAAE,EAAC,UAAU,EAAE,SAAS,EAAC,CAAC,CAAC;YACjE,OAAO,IAAI,GAAG,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;SAClC;QAAC,OAAO,CAAC,EAAE;YACV,OAAO,EAAE,CAAC;SACX;KACF;IACD,MAAM,SAAS,CAAC,EAAC,KAAK,EAAE,MAAM,EAAE,OAAO,EAAC;;QAEtC,IAAI,KAAK,CAAC,QAAQ,CAAC,QAAQ,CAAC,gBAAgB,CAAC;YAAE,OAAO,CAAC,KAAK,CAAC,CAAC;QAE9D,MAAM,SAAS,GAAGC,mCAAiB,CAAC;YAClC,GAAG,MAAoC;YACvC,gBAAgB,EAAE,CAAC,EAAU,KAAK,eAAe,EAAE,EAAE;SACtD,CAAC,CAAC;;;QAGH,IAAI,KAAK,CAAC,IAAI,KAAK,IAAI,IAAI,SAAS,CAAC,kBAAkB,CAAC,QAAQ,CAACC,YAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,EAAE;YACzF,OAAO,CAAC,KAAK,CAAC,CAAC;SAChB;QAED,MAAM,MAAM,GAAG,MAAM,KAAK,CAAC,OAAO,EAAE,CAAC;QACrC,MAAM,MAAM,GAAGC,4BAAU,CACvB;YACE,IAAI,EAAEC,aAAQ,CAAC,OAAO,CAAC,WAAW,EAAE,KAAK,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;YAC3D,QAAQ,EAAE,MAAM;SACjB,EACD,SAAS,CACV,CAAC;QAEF,IAAI,CAAC,MAAM,EAAE;YACX,OAAO,CAAC,KAAK,CAAC,CAAC;SAChB;QAED,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAC3B,MAAM,GAAG,GAAG,IAAIC,6BAAS,EAAE,CAAC;QAC5B,GAAG,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAC1B,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAElB,IAAI,SAAS,CAAC,kBAAkB,CAAC,QAAQ,CAAC,IAAI,KAAK,CAAC,IAAI,EAAE,CAAC,EAAE;YAC3D,KAAK,CAAC,IAAI,GAAG,IAAI,CAAC;SACnB;;QAGD,OAAO,CAAC,KAAK,CAAC,CAAC;KAChB;CACF,CAAC;;;;"}