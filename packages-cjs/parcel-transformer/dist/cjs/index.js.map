{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import { Transformer } from '@parcel/plugin';\nimport SourceMap from '@parcel/source-map';\nimport { IOptionalPreprocessOptions, preprocess, preprocessOptions } from '@aurelia/plugin-conventions';\n// eslint-disable-next-line import/no-nodejs-modules\nimport { relative, extname } from 'path';\n\nexport default new Transformer({\n  async loadConfig({config}) {\n    try {\n      const conf = await config.getConfig([], {packageKey: 'aurelia'});\n      return conf ? conf.contents : {};\n    } catch (e) {\n      return {};\n    }\n  },\n  async transform({asset, config, options}) {\n    const source = await asset.getCode();\n    // leave the initial index.html for parcel.\n    if (asset.type === 'html' && (/^\\s*<!DOCTYPE/i).exec(source)) return [asset];\n\n    const auOptions = preprocessOptions({\n      ...config as IOptionalPreprocessOptions,\n      stringModuleWrap: (id: string) => `bundle-text:${id}`\n    });\n    // after html template is compiled to js, parcel will apply full js transformers chain,\n    // we need to skip them here, then parcel will apply the rest standard js chain.\n    if (asset.type === 'js' && auOptions.templateExtensions.includes(extname(asset.filePath))) {\n      return [asset];\n    }\n\n    const result = preprocess(\n      {\n        path: relative(options.projectRoot, asset.filePath.slice()),\n        contents: source\n      },\n      auOptions\n    );\n\n    if (!result) {\n      return [asset];\n    }\n\n    asset.setCode(result.code);\n    const map = new SourceMap();\n    map.addVLQMap(result.map);\n    asset.setMap(map);\n\n    if (auOptions.templateExtensions.includes(`.${asset.type}`)) {\n      asset.type = 'js';\n    }\n\n    // Return the asset\n    return [asset];\n  }\n});\n"],"names":["Transformer","preprocessOptions","extname","preprocess","relative","SourceMap"],"mappings":";;;;;;;;;;;;;AAMA,YAAe,IAAIA,kBAAW,CAAC;AAC7B,IAAA,MAAM,UAAU,CAAC,EAAC,MAAM,EAAC,EAAA;QACvB,IAAI;AACF,YAAA,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,SAAS,CAAC,EAAE,EAAE,EAAC,UAAU,EAAE,SAAS,EAAC,CAAC,CAAC;YACjE,OAAO,IAAI,GAAG,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;AAClC,SAAA;AAAC,QAAA,OAAO,CAAC,EAAE;AACV,YAAA,OAAO,EAAE,CAAC;AACX,SAAA;KACF;IACD,MAAM,SAAS,CAAC,EAAC,KAAK,EAAE,MAAM,EAAE,OAAO,EAAC,EAAA;AACtC,QAAA,MAAM,MAAM,GAAG,MAAM,KAAK,CAAC,OAAO,EAAE,CAAC;;AAErC,QAAA,IAAI,KAAK,CAAC,IAAI,KAAK,MAAM,IAAI,CAAC,gBAAgB,EAAE,IAAI,CAAC,MAAM,CAAC;YAAE,OAAO,CAAC,KAAK,CAAC,CAAC;QAE7E,MAAM,SAAS,GAAGC,mCAAiB,CAAC;AAClC,YAAA,GAAG,MAAoC;YACvC,gBAAgB,EAAE,CAAC,EAAU,KAAK,CAAA,YAAA,EAAe,EAAE,CAAE,CAAA;AACtD,SAAA,CAAC,CAAC;;;AAGH,QAAA,IAAI,KAAK,CAAC,IAAI,KAAK,IAAI,IAAI,SAAS,CAAC,kBAAkB,CAAC,QAAQ,CAACC,YAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,EAAE;YACzF,OAAO,CAAC,KAAK,CAAC,CAAC;AAChB,SAAA;QAED,MAAM,MAAM,GAAGC,4BAAU,CACvB;AACE,YAAA,IAAI,EAAEC,aAAQ,CAAC,OAAO,CAAC,WAAW,EAAE,KAAK,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;AAC3D,YAAA,QAAQ,EAAE,MAAM;SACjB,EACD,SAAS,CACV,CAAC;QAEF,IAAI,CAAC,MAAM,EAAE;YACX,OAAO,CAAC,KAAK,CAAC,CAAC;AAChB,SAAA;AAED,QAAA,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AAC3B,QAAA,MAAM,GAAG,GAAG,IAAIC,6BAAS,EAAE,CAAC;AAC5B,QAAA,GAAG,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;AAC1B,QAAA,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;AAElB,QAAA,IAAI,SAAS,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAI,CAAA,EAAA,KAAK,CAAC,IAAI,CAAE,CAAA,CAAC,EAAE;AAC3D,YAAA,KAAK,CAAC,IAAI,GAAG,IAAI,CAAC;AACnB,SAAA;;QAGD,OAAO,CAAC,KAAK,CAAC,CAAC;KAChB;AACF,CAAA,CAAC;;;;"}