import{DI as t,IEventAggregator as e,ILogger as n,bound as i,onResolve as r,resolveAll as s,isObject as o,IContainer as a,isArrayIndex as c,Metadata as l,Protocol as h,emptyArray as u,IModuleLoader as d,InstanceProvider as p,noop as g,Registration as f}from"../../../kernel/dist/native-modules/index.js";import{isCustomElementViewModel as v,IHistory as m,ILocation as w,IWindow as y,Controller as x,CustomElement as $,IPlatform as b,CustomElementDefinition as S,IAppRoot as k,IController as C,isCustomElementController as T,bindable as P,customElement as R,BindingMode as E,customAttribute as A,IEventTarget as N,INode as I,IEventDelegator as U,getRef as L,CustomAttribute as O,AppTask as j}from"../../../runtime-html/dist/native-modules/index.js";import{RouteRecognizer as V}from"../../../route-recognizer/dist/native-modules/index.js";class H{constructor(t,e,n){this.stack=t,this.cb=e,this.done=!1,this.next=null,this.head=null!=n?n:this}static start(t){return new H(0,t,null)}push(){let t=this;do{++t.stack,t=t.next}while(null!==t)}pop(){let t=this;do{0==--t.stack&&t.invoke(),t=t.next}while(null!==t)}invoke(){const t=this.cb;null!==t&&(this.cb=null,t(this),this.done=!0)}continueWith(t){return null===this.next?this.next=new H(this.stack,t,this.head):this.next.continueWith(t)}start(){return this.head.push(),this.head.pop(),this}}function W(t,e){t=t.slice(),e=e.slice();const n=[];for(;t.length>0;){const i=t.shift();if(n.every((t=>t.context.vpa!==i.context.vpa))){const t=e.findIndex((t=>t.context.vpa===i.context.vpa));t>=0?n.push(...e.splice(0,t+1)):n.push(i)}}return n.push(...e),n}function q(t){try{return JSON.stringify(t)}catch(e){return Object.prototype.toString.call(t)}}function M(t){return"string"==typeof t?[t]:t}function D(t){return"object"==typeof t&&null!==t&&!v(t)}function z(t){return D(t)&&!0===Object.prototype.hasOwnProperty.call(t,"name")}function _(t){return D(t)&&!0===Object.prototype.hasOwnProperty.call(t,"component")}function F(t){return D(t)&&!0===Object.prototype.hasOwnProperty.call(t,"redirectTo")}function B(t){return D(t)&&!0===Object.prototype.hasOwnProperty.call(t,"component")}function Y(t,e,n){throw new Error(`Invalid route config property: "${e}". Expected ${t}, but got ${q(n)}.`)}function K(t,e){if(null==t)throw new Error(`Invalid route config: expected an object or string, but got: ${String(t)}.`);const n=Object.keys(t);for(const i of n){const n=t[i],r=[e,i].join(".");switch(i){case"id":case"viewport":case"redirectTo":"string"!=typeof n&&Y("string",r,n);break;case"caseSensitive":"boolean"!=typeof n&&Y("boolean",r,n);break;case"data":"object"==typeof n&&null!==n||Y("object",r,n);break;case"title":switch(typeof n){case"string":case"function":break;default:Y("string or function",r,n)}break;case"path":if(n instanceof Array)for(let t=0;t<n.length;++t)"string"!=typeof n[t]&&Y("string",`${r}[${t}]`,n[t]);else"string"!=typeof n&&Y("string or Array of strings",r,n);break;case"component":G(n,r);break;case"routes":n instanceof Array||Y("Array",r,n);for(const t of n){G(t,`${r}[${n.indexOf(t)}]`)}break;case"transitionPlan":switch(typeof n){case"string":switch(n){case"none":case"replace":case"invoke-lifecycles":break;default:Y("string('none'|'replace'|'invoke-lifecycles') or function",r,n)}break;case"function":break;default:Y("string('none'|'replace'|'invoke-lifecycles') or function",r,n)}break;default:throw new Error(`Unknown route config property: "${e}.${i}". Please specify known properties only.`)}}}function G(t,e){switch(typeof t){case"function":break;case"object":if(t instanceof Promise)break;if(F(t)){!function(t,e){if(null==t)throw new Error(`Invalid route config: expected an object or string, but got: ${String(t)}.`);const n=Object.keys(t);for(const i of n){const n=t[i],r=[e,i].join(".");switch(i){case"path":case"redirectTo":"string"!=typeof n&&Y("string",r,n);break;default:throw new Error(`Unknown redirect config property: "${e}.${i}". Only 'path' and 'redirectTo' should be specified for redirects.`)}}}(t,e);break}if(_(t)){K(t,e);break}v(t)||z(t)||Y("an object with at least a 'component' property (see Routeable)",e,t);break;case"string":break;default:Y("function, object or string (see Routeable)",e,t)}}function J(t,e){if(t===e)return!0;if(typeof t!=typeof e)return!1;if(null===t||null===e)return!1;if(Object.getPrototypeOf(t)!==Object.getPrototypeOf(e))return!1;const n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return!1;for(let r=0,s=n.length;r<s;++r){const s=n[r];if(s!==i[r])return!1;if(t[s]!==e[s])return!1}return!0}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function Q(t,e,n,i){var r,s=arguments.length,o=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(s<3?r(o):s>3?r(e,n,o):r(e,n))||o);return s>3&&o&&Object.defineProperty(e,n,o),o}function Z(t,e){return function(n,i){e(n,i,t)}}class X{constructor(t,e,n){this.events=t,this.serial=e,this.inner=n,this.disposed=!1}dispose(){if(!this.disposed){this.disposed=!0,this.inner.dispose();const t=this.events.subscriptions;t.splice(t.indexOf(this),1)}}}const tt=t.createInterface("IRouterEvents",(t=>t.singleton(et)));let et=class{constructor(t,e){this.ea=t,this.logger=e,this.subscriptionSerial=0,this.subscriptions=[],this.logger=e.scopeTo("RouterEvents")}publish(t){this.logger.trace("publishing %s",t),this.ea.publish(t.name,t)}subscribe(t,e){const n=new X(this,++this.subscriptionSerial,this.ea.subscribe(t,(i=>{this.logger.trace(`handling %s for subscription #${n.serial}`,t),e(i)})));return this.subscriptions.push(n),n}};et=Q([Z(0,e),Z(1,n)],et);class nt{constructor(t,e,n,i){this.id=t,this.url=e,this.trigger=n,this.state=i}get name(){return"au:router:location-change"}toString(){return`LocationChangeEvent(id:${this.id},url:'${this.url}',trigger:'${this.trigger}')`}}class it{constructor(t,e,n,i){this.id=t,this.instructions=e,this.trigger=n,this.managedState=i}get name(){return"au:router:navigation-start"}toString(){return`NavigationStartEvent(id:${this.id},instructions:'${this.instructions}',trigger:'${this.trigger}')`}}class rt{constructor(t,e,n){this.id=t,this.instructions=e,this.finalInstructions=n}get name(){return"au:router:navigation-end"}toString(){return`NavigationEndEvent(id:${this.id},instructions:'${this.instructions}',finalInstructions:'${this.finalInstructions}')`}}class st{constructor(t,e,n){this.id=t,this.instructions=e,this.reason=n}get name(){return"au:router:navigation-cancel"}toString(){return`NavigationCancelEvent(id:${this.id},instructions:'${this.instructions}',reason:${String(this.reason)})`}}class ot{constructor(t,e,n){this.id=t,this.instructions=e,this.error=n}get name(){return"au:router:navigation-error"}toString(){return`NavigationErrorEvent(id:${this.id},instructions:'${this.instructions}',error:${String(this.error)})`}}const at=t.createInterface("IBaseHrefProvider",(t=>t.singleton(lt)));class ct{constructor(t,e){this.path=t,this.rootedPath=e}}let lt=class{constructor(t){this.window=t}getBaseHref(){var t;const e=this.window.document.head.querySelector("base");if(null===e)return null;const n=dt(e.href),i=dt(null!==(t=e.getAttribute("href"))&&void 0!==t?t:"");return new ct(i,n)}};lt=Q([Z(0,y)],lt);const ht=t.createInterface("ILocationManager",(t=>t.singleton(ut)));let ut=class{constructor(t,e,n,i,r,s){var o;this.logger=t,this.events=e,this.history=n,this.location=i,this.window=r,this.baseHrefProvider=s,this.eventId=0,this.logger=t.root.scopeTo("LocationManager");const a=s.getBaseHref();if(null===a){const t=null!==(o=i.origin)&&void 0!==o?o:"",e=this.baseHref=new ct("",dt(t));this.logger.warn(`no baseHref provided, defaulting to origin '${e.rootedPath}' (normalized from '${t}')`)}else this.baseHref=a,this.logger.debug(`baseHref set to path: '${a.path}', rootedPath: '${a.rootedPath}'`)}startListening(){this.logger.trace("startListening()"),this.window.addEventListener("popstate",this.onPopState,!1),this.window.addEventListener("hashchange",this.onHashChange,!1)}stopListening(){this.logger.trace("stopListening()"),this.window.removeEventListener("popstate",this.onPopState,!1),this.window.removeEventListener("hashchange",this.onHashChange,!1)}onPopState(t){this.logger.trace("onPopState()"),this.events.publish(new nt(++this.eventId,this.getPath(),"popstate",t.state))}onHashChange(t){this.logger.trace("onHashChange()"),this.events.publish(new nt(++this.eventId,this.getPath(),"hashchange",null))}pushState(t,e,n){n=this.addBaseHref(n);try{const i=JSON.stringify(t);this.logger.trace(`pushState(state:${i},title:'${e}',url:'${n}')`)}catch(t){this.logger.warn(`pushState(state:NOT_SERIALIZABLE,title:'${e}',url:'${n}')`)}this.history.pushState(t,e,n)}replaceState(t,e,n){n=this.addBaseHref(n);try{const i=JSON.stringify(t);this.logger.trace(`replaceState(state:${i},title:'${e}',url:'${n}')`)}catch(t){this.logger.warn(`replaceState(state:NOT_SERIALIZABLE,title:'${e}',url:'${n}')`)}this.history.replaceState(t,e,n)}getPath(){const{pathname:t,search:e,hash:n}=this.location,i=this.removeBaseHref(`${t}${r=e,r.length>0&&!r.startsWith("?")?`?${r}`:r}${n}`);var r;return this.logger.trace(`getPath() -> '${i}'`),i}currentPathEquals(t){const e=this.getPath()===this.removeBaseHref(t);return this.logger.trace(`currentPathEquals(path:'${t}') -> ${e}`),e}addBaseHref(t){const e=t;let n,i=this.baseHref.rootedPath;return i.endsWith("/")&&(i=i.slice(0,-1)),0===i.length?n=t:(t.startsWith("/")&&(t=t.slice(1)),n=`${i}/${t}`),this.logger.trace(`addBaseHref(path:'${e}') -> '${n}'`),n}removeBaseHref(t){const e=t;return t.startsWith(this.baseHref.path)&&(t=t.slice(this.baseHref.path.length)),t=dt(t),this.logger.trace(`removeBaseHref(path:'${e}') -> '${t}'`),t}};function dt(t){let e,n,i;return(i=t.indexOf("?"))>=0||(i=t.indexOf("#"))>=0?(e=t.slice(0,i),n=t.slice(i)):(e=t,n=""),e.endsWith("/")?e=e.slice(0,-1):e.endsWith("/index.html")&&(e=e.slice(0,-11)),`${e}${n}`}Q([i],ut.prototype,"onPopState",null),Q([i],ut.prototype,"onHashChange",null),ut=Q([Z(0,n),Z(1,tt),Z(2,m),Z(3,w),Z(4,y),Z(5,at)],ut);class pt{constructor(t,e,n,i){this.viewportName=t,this.componentName=e,this.resolution=n,this.append=i}static create(t){return new pt(t.viewportName,t.componentName,t.resolution,t.append)}toString(){return`VR(viewport:'${this.viewportName}',component:'${this.componentName}',resolution:'${this.resolution}',append:${this.append})`}}const gt=new WeakMap;class ft{constructor(t,e,i){this.viewport=t,this.hostController=e,this.ctx=i,this.isActive=!1,this.curCA=null,this.nextCA=null,this.state=8256,this.$resolution="dynamic",this.$plan="replace",this.currNode=null,this.nextNode=null,this.currTransition=null,this.prevTransition=null,this.logger=i.container.get(n).scopeTo(`ViewportAgent<${i.friendlyPath}>`),this.logger.trace("constructor()")}get $state(){return function(t){let e=yt.get(t);void 0===e&&yt.set(t,e=function(t){const e=[];8192==(8192&t)&&e.push("currIsEmpty");4096==(4096&t)&&e.push("currIsActive");2048==(2048&t)&&e.push("currCanUnload");1024==(1024&t)&&e.push("currCanUnloadDone");512==(512&t)&&e.push("currUnload");256==(256&t)&&e.push("currUnloadDone");128==(128&t)&&e.push("currDeactivate");64==(64&t)&&e.push("nextIsEmpty");32==(32&t)&&e.push("nextIsScheduled");16==(16&t)&&e.push("nextCanLoad");8==(8&t)&&e.push("nextCanLoadDone");4==(4&t)&&e.push("nextLoad");2==(2&t)&&e.push("nextLoadDone");1==(1&t)&&e.push("nextActivate");return e.join("|")}(t));return e}(this.state)}get currState(){return 16256&this.state}set currState(t){this.state=127&this.state|t}get nextState(){return 127&this.state}set nextState(t){this.state=16256&this.state|t}static for(t,e){let n=gt.get(t);if(void 0===n){const i=x.getCachedOrThrow(t);gt.set(t,n=new ft(t,i,e))}return n}activateFromViewport(t,e,n){const i=this.currTransition;switch(null!==i&&mt(i),this.isActive=!0,this.nextState){case 64:switch(this.currState){case 8192:return void this.logger.trace("activateFromViewport() - nothing to activate at %s",this);case 4096:return this.logger.trace("activateFromViewport() - activating existing componentAgent at %s",this),this.curCA.activate(t,e,n);default:this.unexpectedState("activateFromViewport 1")}case 2:{if(null===this.currTransition)throw new Error(`Unexpected viewport activation outside of a transition context at ${this}`);if("static"!==this.$resolution)throw new Error(`Unexpected viewport activation at ${this}`);this.logger.trace("activateFromViewport() - running ordinary activate at %s",this);const e=H.start((e=>{this.activate(t,this.currTransition,e)})),n=new Promise((t=>{e.continueWith((()=>{t()}))}));return e.start().done?void 0:n}default:this.unexpectedState("activateFromViewport 2")}}deactivateFromViewport(t,e,n){const i=this.currTransition;switch(null!==i&&mt(i),this.isActive=!1,this.currState){case 8192:return void this.logger.trace("deactivateFromViewport() - nothing to deactivate at %s",this);case 4096:return this.logger.trace("deactivateFromViewport() - deactivating existing componentAgent at %s",this),this.curCA.deactivate(t,e,n);case 128:return void this.logger.trace("deactivateFromViewport() - already deactivating at %s",this);default:{if(null===this.currTransition)throw new Error(`Unexpected viewport deactivation outside of a transition context at ${this}`);this.logger.trace("deactivateFromViewport() - running ordinary deactivate at %s",this);const e=H.start((e=>{this.deactivate(t,this.currTransition,e)})),n=new Promise((t=>{e.continueWith((()=>{t()}))}));return e.start().done?void 0:n}}}handles(t){return!!this.isAvailable(t.resolution)&&(t.append&&4096===this.currState?(this.logger.trace("handles(req:%s) -> false (append mode, viewport already has content %s)",t,this.curCA),!1):t.viewportName.length>0&&this.viewport.name!==t.viewportName?(this.logger.trace("handles(req:%s) -> false (names don't match)",t),!1):this.viewport.usedBy.length>0&&!this.viewport.usedBy.split(",").includes(t.componentName)?(this.logger.trace("handles(req:%s) -> false (componentName not included in usedBy)",t),!1):(this.logger.trace("handles(req:%s) -> true",t),!0))}isAvailable(t){return"dynamic"!==t||this.isActive?64===this.nextState||(this.logger.trace("isAvailable(resolution:%s) -> false (update already scheduled for %s)",t,this.nextNode),!1):(this.logger.trace("isAvailable(resolution:%s) -> false (viewport is not active and we're in dynamic resolution resolution)",t),!1)}canUnload(t,e){null===this.currTransition&&(this.currTransition=t),mt(t),!0===t.guardsResult&&(e.push(),H.start((e=>{this.logger.trace("canUnload() - invoking on children at %s",this);for(const n of this.currNode.children)n.context.vpa.canUnload(t,e)})).continueWith((e=>{switch(this.currState){case 4096:switch(this.logger.trace("canUnload() - invoking on existing component at %s",this),this.$plan){case"none":return void(this.currState=1024);case"invoke-lifecycles":case"replace":return this.currState=2048,e.push(),void H.start((e=>{this.logger.trace("canUnload() - finished invoking on children, now invoking on own component at %s",this),this.curCA.canUnload(t,this.nextNode,e)})).continueWith((()=>{this.logger.trace("canUnload() - finished at %s",this),this.currState=1024,e.pop()})).start()}case 8192:return void this.logger.trace("canUnload() - nothing to unload at %s",this);default:t.handleError(new Error(`Unexpected state at canUnload of ${this}`))}})).continueWith((()=>{e.pop()})).start())}canLoad(t,e){null===this.currTransition&&(this.currTransition=t),mt(t),!0===t.guardsResult&&(e.push(),H.start((e=>{switch(this.nextState){case 32:switch(this.logger.trace("canLoad() - invoking on new component at %s",this),this.nextState=16,this.$plan){case"none":return;case"invoke-lifecycles":return this.curCA.canLoad(t,this.nextNode,e);case"replace":return this.nextCA=this.nextNode.context.createComponentAgent(this.hostController,this.nextNode),this.nextCA.canLoad(t,this.nextNode,e)}case 64:return void this.logger.trace("canLoad() - nothing to load at %s",this);default:this.unexpectedState("canLoad")}})).continueWith((t=>{const e=this.nextNode;switch(this.$plan){case"none":case"invoke-lifecycles":return this.logger.trace("canLoad(next:%s) - plan set to '%s', compiling residue",e,this.$plan),t.push(),void r(Mt(e),(()=>{t.pop()}));case"replace":switch(this.$resolution){case"dynamic":return void this.logger.trace("canLoad(next:%s) - (resolution: 'dynamic'), delaying residue compilation until activate",e,this.$plan);case"static":return this.logger.trace(`canLoad(next:%s) - (resolution: '${this.$resolution}'), creating nextCA and compiling residue`,e,this.$plan),t.push(),void r(Mt(e),(()=>{t.pop()}))}}})).continueWith((e=>{switch(this.nextState){case 16:this.logger.trace("canLoad() - finished own component, now invoking on children at %s",this),this.nextState=8;for(const n of this.nextNode.children)n.context.vpa.canLoad(t,e);return;case 64:return;default:this.unexpectedState("canLoad")}})).continueWith((()=>{this.logger.trace("canLoad() - finished at %s",this),e.pop()})).start())}unload(t,e){mt(t),vt(this,t),e.push(),H.start((e=>{this.logger.trace("unload() - invoking on children at %s",this);for(const n of this.currNode.children)n.context.vpa.unload(t,e)})).continueWith((n=>{switch(this.currState){case 1024:switch(this.logger.trace("unload() - invoking on existing component at %s",this),this.$plan){case"none":return void(this.currState=256);case"invoke-lifecycles":case"replace":return this.currState=512,n.push(),void H.start((e=>{this.logger.trace("unload() - finished invoking on children, now invoking on own component at %s",this),this.curCA.unload(t,this.nextNode,e)})).continueWith((()=>{this.logger.trace("unload() - finished at %s",this),this.currState=256,n.pop()})).start()}case 8192:this.logger.trace("unload() - nothing to unload at %s",this);for(const n of this.currNode.children)n.context.vpa.unload(t,e);return;default:this.unexpectedState("unload")}})).continueWith((()=>{e.pop()})).start()}load(t,e){mt(t),vt(this,t),e.push(),H.start((e=>{switch(this.nextState){case 8:switch(this.logger.trace("load() - invoking on new component at %s",this),this.nextState=4,this.$plan){case"none":return;case"invoke-lifecycles":return this.curCA.load(t,this.nextNode,e);case"replace":return this.nextCA.load(t,this.nextNode,e)}case 64:return void this.logger.trace("load() - nothing to load at %s",this);default:this.unexpectedState("load")}})).continueWith((e=>{switch(this.nextState){case 4:this.logger.trace("load() - finished own component, now invoking on children at %s",this),this.nextState=2;for(const n of this.nextNode.children)n.context.vpa.load(t,e);return;case 64:return;default:this.unexpectedState("load")}})).continueWith((()=>{this.logger.trace("load() - finished at %s",this),e.pop()})).start()}deactivate(t,e,n){switch(mt(e),vt(this,e),n.push(),this.currState){case 256:switch(this.logger.trace("deactivate() - invoking on existing component at %s",this),this.currState=128,this.$plan){case"none":case"invoke-lifecycles":return void n.pop();case"replace":{const i=this.hostController,r=this.viewport.stateful?0:32;e.run((()=>this.curCA.deactivate(t,i,r)),(()=>{n.pop()}))}}return;case 8192:return this.logger.trace("deactivate() - nothing to deactivate at %s",this),void n.pop();case 128:return this.logger.trace("deactivate() - already deactivating at %s",this),void n.pop();default:this.unexpectedState("deactivate")}}activate(t,e,n){if(mt(e),vt(this,e),n.push(),32===this.nextState&&"dynamic"===this.$resolution)return this.logger.trace("activate() - invoking canLoad(), load() and activate() on new component due to resolution 'dynamic' at %s",this),void H.start((t=>{this.canLoad(e,t)})).continueWith((t=>{this.load(e,t)})).continueWith((n=>{this.activate(t,e,n)})).continueWith((()=>{n.pop()})).start();switch(this.nextState){case 2:return this.logger.trace("activate() - invoking on existing component at %s",this),this.nextState=1,void H.start((n=>{switch(this.$plan){case"none":case"invoke-lifecycles":return;case"replace":{const i=this.hostController,r=0;e.run((()=>(n.push(),this.nextCA.activate(t,i,r))),(()=>{n.pop()}))}}})).continueWith((t=>{this.processDynamicChildren(e,t)})).continueWith((()=>{n.pop()})).start();case 64:return this.logger.trace("activate() - nothing to activate at %s",this),void n.pop();default:this.unexpectedState("activate")}}swap(t,e){if(8192===this.currState)return this.logger.trace("swap() - running activate on next instead, because there is nothing to deactivate at %s",this),void this.activate(null,t,e);if(64===this.nextState)return this.logger.trace("swap() - running deactivate on current instead, because there is nothing to activate at %s",this),void this.deactivate(null,t,e);switch(mt(t),vt(this,t),256===this.currState&&2===this.nextState||this.unexpectedState("swap"),this.currState=128,this.nextState=1,this.$plan){case"none":case"invoke-lifecycles":{this.logger.trace("swap() - skipping this level and swapping children instead at %s",this);const n=W(this.nextNode.children,this.currNode.children);for(const i of n)i.context.vpa.swap(t,e);return}case"replace":{this.logger.trace("swap() - running normally at %s",this);const n=this.hostController,i=this.curCA,r=this.nextCA,s=this.viewport.stateful?0:32,o=0;switch(e.push(),t.options.swapStrategy){case"sequential-add-first":return void H.start((e=>{t.run((()=>(e.push(),r.activate(null,n,o))),(()=>{e.pop()}))})).continueWith((e=>{this.processDynamicChildren(t,e)})).continueWith((()=>{t.run((()=>i.deactivate(null,n,s)),(()=>{e.pop()}))})).start();case"sequential-remove-first":return void H.start((e=>{t.run((()=>(e.push(),i.deactivate(null,n,s))),(()=>{e.pop()}))})).continueWith((e=>{t.run((()=>(e.push(),r.activate(null,n,o))),(()=>{e.pop()}))})).continueWith((e=>{this.processDynamicChildren(t,e)})).continueWith((()=>{e.pop()})).start();case"parallel-remove-first":return t.run((()=>(e.push(),i.deactivate(null,n,s))),(()=>{e.pop()})),void H.start((e=>{t.run((()=>(e.push(),r.activate(null,n,o))),(()=>{e.pop()}))})).continueWith((e=>{this.processDynamicChildren(t,e)})).continueWith((()=>{e.pop()})).start()}}}}processDynamicChildren(t,e){this.logger.trace("processDynamicChildren() - %s",this);const i=this.nextNode;t.run((()=>(e.push(),function(t){const e=t.context,i=e.container.get(n).scopeTo("RouteTree");return i.trace(`getDynamicChildren(node:%s)${e.resolved instanceof Promise?" - awaiting promise":""}`,t),r(e.resolved,(()=>{const n=t.children.slice();return r(s(...t.residue.splice(0).map((e=>Dt(i,t,e,t.append))),...e.getAvailableViewportAgents("dynamic").map((e=>{const n=ie.create({component:e.viewport.default,viewport:e.viewport.name});return Dt(i,t,n,t.append)}))),(()=>t.children.filter((t=>!n.includes(t)))))}))}(i))),(n=>{H.start((e=>{for(const i of n)t.run((()=>(e.push(),i.context.vpa.canLoad(t,e))),(()=>{e.pop()}))})).continueWith((e=>{for(const i of n)t.run((()=>(e.push(),i.context.vpa.load(t,e))),(()=>{e.pop()}))})).continueWith((e=>{for(const i of n)t.run((()=>(e.push(),i.context.vpa.activate(null,t,e))),(()=>{e.pop()}))})).continueWith((()=>{e.pop()})).start()}))}scheduleUpdate(t,e){var n,i;switch(this.nextState){case 64:this.nextNode=e,this.nextState=32,this.$resolution=t.resolutionMode;break;default:this.unexpectedState("scheduleUpdate 1")}switch(this.currState){case 8192:case 4096:case 1024:break;default:this.unexpectedState("scheduleUpdate 2")}const r=null!==(i=null===(n=this.curCA)||void 0===n?void 0:n.routeNode)&&void 0!==i?i:null;if(null===r||r.component!==e.component)this.$plan="replace";else{const t=e.context.definition.config.transitionPlan;this.$plan="function"==typeof t?t(r,e):t}this.logger.trace("scheduleUpdate(next:%s) - plan set to '%s'",e,this.$plan)}cancelUpdate(){switch(null!==this.currNode&&this.currNode.children.forEach((function(t){t.context.vpa.cancelUpdate()})),null!==this.nextNode&&this.nextNode.children.forEach((function(t){t.context.vpa.cancelUpdate()})),this.logger.trace("cancelUpdate(nextNode:%s)",this.nextNode),this.currState){case 8192:case 4096:break;case 2048:case 1024:this.currState=4096}switch(this.nextState){case 64:case 32:case 16:case 8:this.nextNode=null,this.nextState=64}}endTransition(){if(null!==this.currNode&&this.currNode.children.forEach((function(t){t.context.vpa.endTransition()})),null!==this.nextNode&&this.nextNode.children.forEach((function(t){t.context.vpa.endTransition()})),null!==this.currTransition){switch(mt(this.currTransition),this.nextState){case 64:switch(this.currState){case 128:this.logger.trace("endTransition() - setting currState to State.nextIsEmpty at %s",this),this.currState=8192,this.curCA=null;break;default:this.unexpectedState("endTransition 1")}break;case 1:switch(this.currState){case 8192:case 128:switch(this.$plan){case"none":case"invoke-lifecycles":this.logger.trace("endTransition() - setting currState to State.currIsActive at %s",this),this.currState=4096;break;case"replace":this.logger.trace("endTransition() - setting currState to State.currIsActive and reassigning curCA at %s",this),this.currState=4096,this.curCA=this.nextCA}this.currNode=this.nextNode;break;default:this.unexpectedState("endTransition 2")}break;default:this.unexpectedState("endTransition 3")}this.$plan="replace",this.nextState=64,this.nextNode=null,this.nextCA=null,this.prevTransition=this.currTransition,this.currTransition=null}}toString(){return`VPA(state:${this.$state},plan:'${this.$plan}',resolution:'${this.$resolution}',n:${this.nextNode},c:${this.currNode},viewport:${this.viewport})`}dispose(){var t;this.viewport.stateful?this.logger.trace("dispose() - not disposing stateful viewport at %s",this):(this.logger.trace("dispose() - disposing %s",this),null===(t=this.curCA)||void 0===t||t.dispose())}unexpectedState(t){throw new Error(`Unexpected state at ${t} of ${this}`)}}function vt(t,e){if(!0!==e.guardsResult)throw new Error(`Unexpected guardsResult ${e.guardsResult} at ${t}`)}function mt(t){if(void 0!==t.error)throw t.error}var wt;!function(t){t[t.curr=16256]="curr",t[t.currIsEmpty=8192]="currIsEmpty",t[t.currIsActive=4096]="currIsActive",t[t.currCanUnload=2048]="currCanUnload",t[t.currCanUnloadDone=1024]="currCanUnloadDone",t[t.currUnload=512]="currUnload",t[t.currUnloadDone=256]="currUnloadDone",t[t.currDeactivate=128]="currDeactivate",t[t.next=127]="next",t[t.nextIsEmpty=64]="nextIsEmpty",t[t.nextIsScheduled=32]="nextIsScheduled",t[t.nextCanLoad=16]="nextCanLoad",t[t.nextCanLoadDone=8]="nextCanLoadDone",t[t.nextLoad=4]="nextLoad",t[t.nextLoadDone=2]="nextLoadDone",t[t.nextActivate=1]="nextActivate",t[t.bothAreEmpty=8256]="bothAreEmpty"}(wt||(wt={}));const yt=new Map;const xt=["?","#","/","+","(",")",".","@","!","=",",","&","'","~",";"];class $t{constructor(t){this.input=t,this.buffers=[],this.bufferIndex=0,this.index=0,this.rest=t}get done(){return 0===this.rest.length}startsWith(...t){const e=this.rest;return t.some((function(t){return e.startsWith(t)}))}consumeOptional(t){return!!this.startsWith(t)&&(this.rest=this.rest.slice(t.length),this.index+=t.length,this.append(t),!0)}consume(t){this.consumeOptional(t)||this.expect(`'${t}'`)}expect(t){throw new Error(`Expected ${t} at index ${this.index} of '${this.input}', but got: '${this.rest}' (rest='${this.rest}')`)}ensureDone(){if(!this.done)throw new Error(`Unexpected '${this.rest}' at index ${this.index} of '${this.input}'`)}advance(){const t=this.rest[0];this.rest=this.rest.slice(1),++this.index,this.append(t)}record(){this.buffers[this.bufferIndex++]=""}playback(){const t=--this.bufferIndex,e=this.buffers,n=e[t];return e[t]="",n}discard(){this.buffers[--this.bufferIndex]=""}append(t){const e=this.bufferIndex,n=this.buffers;for(let i=0;i<e;++i)n[i]+=t}}var bt;!function(t){t[t.Route=0]="Route",t[t.CompositeSegment=1]="CompositeSegment",t[t.ScopedSegment=2]="ScopedSegment",t[t.SegmentGroup=3]="SegmentGroup",t[t.Segment=4]="Segment",t[t.Component=5]="Component",t[t.Action=6]="Action",t[t.Viewport=7]="Viewport",t[t.ParameterList=8]="ParameterList",t[t.Parameter=9]="Parameter"}(bt||(bt={}));const St=new Map,kt=new Map;class Ct{constructor(t,e,n,i,r,s){this.raw=t,this.isAbsolute=e,this.root=n,this.queryParams=i,this.fragment=r,this.fragmentIsRoute=s}get kind(){return 0}static parse(t,e){const n=e?St:kt;let i=n.get(t);return void 0===i&&n.set(t,i=Ct.$parse(t,e)),i}static $parse(t,e){let n;const i=t.indexOf("#");if(i>=0){const r=t.slice(i+1);n=decodeURIComponent(r),t=e?n:t.slice(0,i)}else e&&(t=""),n=null;let r=null;const s=t.indexOf("?");if(s>=0){const e=t.slice(s+1);t=t.slice(0,s),r=new URLSearchParams(e)}if(""===t)return new Ct("",!1,Et.EMPTY,Object.freeze(null!=r?r:new URLSearchParams),n,e);const o=new $t(t);o.record();const a=o.consumeOptional("/"),c=Tt.parse(o);o.ensureDone();const l=o.playback();return new Ct(l,a,c,Object.freeze(null!=r?r:new URLSearchParams),n,e)}toInstructionTree(t){return new se(t,this.isAbsolute,this.root.toInstructions(t.append,0,0),this.queryParams,this.fragment)}toString(){return this.raw}}class Tt{constructor(t,e,n){this.raw=t,this.siblings=e,this.append=n}get kind(){return 1}static parse(t){t.record();const e=t.consumeOptional("+"),n=[];do{n.push(Pt.parse(t))}while(t.consumeOptional("+"));if(!e&&1===n.length)return t.discard(),n[0];const i=t.playback();return new Tt(i,n,e)}toInstructions(t,e,n){switch(this.siblings.length){case 0:return[];case 1:return this.siblings[0].toInstructions(t,e,n);case 2:return[...this.siblings[0].toInstructions(t,e,0),...this.siblings[1].toInstructions(t,0,n)];default:return[...this.siblings[0].toInstructions(t,e,0),...this.siblings.slice(1,-1).flatMap((function(e){return e.toInstructions(t,0,0)})),...this.siblings[this.siblings.length-1].toInstructions(t,0,n)]}}toString(){return this.raw}}class Pt{constructor(t,e,n){this.raw=t,this.left=e,this.right=n}get kind(){return 2}static parse(t){t.record();const e=Rt.parse(t);if(t.consumeOptional("/")){const n=Pt.parse(t),i=t.playback();return new Pt(i,e,n)}return t.discard(),e}toInstructions(t,e,n){const i=this.left.toInstructions(t,e,0),r=this.right.toInstructions(!1,0,n);let s=i[i.length-1];for(;s.children.length>0;)s=s.children[s.children.length-1];return s.children.push(...r),i}toString(){return this.raw}}class Rt{constructor(t,e){this.raw=t,this.expression=e}get kind(){return 3}static parse(t){if(t.record(),t.consumeOptional("(")){const e=Tt.parse(t);t.consume(")");const n=t.playback();return new Rt(n,e)}return t.discard(),Et.parse(t)}toInstructions(t,e,n){return this.expression.toInstructions(t,e+1,n+1)}toString(){return this.raw}}class Et{constructor(t,e,n,i,r){this.raw=t,this.component=e,this.action=n,this.viewport=i,this.scoped=r}get kind(){return 4}static get EMPTY(){return new Et("",At.EMPTY,Nt.EMPTY,It.EMPTY,!0)}static parse(t){t.record();const e=At.parse(t),n=Nt.parse(t),i=It.parse(t),r=!t.consumeOptional("!"),s=t.playback();return new Et(s,e,n,i,r)}toInstructions(t,e,n){return[ie.create({component:this.component.name,params:this.component.parameterList.toObject(),viewport:this.viewport.name,append:t,open:e,close:n})]}toString(){return this.raw}}class At{constructor(t,e,n){switch(this.raw=t,this.name=e,this.parameterList=n,e.charAt(0)){case":":this.isParameter=!0,this.isStar=!1,this.isDynamic=!0,this.parameterName=e.slice(1);break;case"*":this.isParameter=!1,this.isStar=!0,this.isDynamic=!0,this.parameterName=e.slice(1);break;default:this.isParameter=!1,this.isStar=!1,this.isDynamic=!1,this.parameterName=e}}get kind(){return 5}static get EMPTY(){return new At("","",Ut.EMPTY)}static parse(t){if(t.record(),t.record(),!t.done)if(t.startsWith("./"))t.advance();else if(t.startsWith("../"))t.advance(),t.advance();else for(;!t.done&&!t.startsWith(...xt);)t.advance();const e=decodeURIComponent(t.playback());0===e.length&&t.expect("component name");const n=Ut.parse(t),i=t.playback();return new At(i,e,n)}toString(){return this.raw}}class Nt{constructor(t,e,n){this.raw=t,this.name=e,this.parameterList=n}get kind(){return 6}static get EMPTY(){return new Nt("","",Ut.EMPTY)}static parse(t){t.record();let e="";if(t.consumeOptional(".")){for(t.record();!t.done&&!t.startsWith(...xt);)t.advance();e=decodeURIComponent(t.playback()),0===e.length&&t.expect("method name")}const n=Ut.parse(t),i=t.playback();return new Nt(i,e,n)}toString(){return this.raw}}class It{constructor(t,e){this.raw=t,this.name=e}get kind(){return 7}static get EMPTY(){return new It("","")}static parse(t){t.record();let e="";if(t.consumeOptional("@")){for(t.record();!t.done&&!t.startsWith(...xt);)t.advance();e=decodeURIComponent(t.playback()),0===e.length&&t.expect("viewport name")}const n=t.playback();return new It(n,e)}toString(){return this.raw}}class Ut{constructor(t,e){this.raw=t,this.expressions=e}get kind(){return 8}static get EMPTY(){return new Ut("",[])}static parse(t){t.record();const e=[];if(t.consumeOptional("(")){do{if(e.push(Lt.parse(t,e.length)),!t.consumeOptional(","))break}while(!t.done&&!t.startsWith(")"));t.consume(")")}const n=t.playback();return new Ut(n,e)}toObject(){const t={};for(const e of this.expressions)t[e.key]=e.value;return t}toString(){return this.raw}}class Lt{constructor(t,e,n){this.raw=t,this.key=e,this.value=n}get kind(){return 9}static get EMPTY(){return new Lt("","","")}static parse(t,e){for(t.record(),t.record();!t.done&&!t.startsWith(...xt);)t.advance();let n,i=decodeURIComponent(t.playback());if(0===i.length&&t.expect("parameter key"),t.consumeOptional("=")){for(t.record();!t.done&&!t.startsWith(...xt);)t.advance();n=decodeURIComponent(t.playback()),0===n.length&&t.expect("parameter value")}else n=i,i=e.toString();const r=t.playback();return new Lt(r,i,n)}toString(){return this.raw}}const Ot=Object.freeze({RouteExpression:Ct,CompositeSegmentExpression:Tt,ScopedSegmentExpression:Pt,SegmentGroupExpression:Rt,SegmentExpression:Et,ComponentExpression:At,ActionExpression:Nt,ViewportExpression:It,ParameterListExpression:Ut,ParameterExpression:Lt});let jt=0;class Vt{constructor(t,e,n,i,r,s,o,a,c,l,h,u,d,p,g,f){this.id=t,this.path=e,this.finalPath=n,this.context=i,this.originalInstruction=r,this.instruction=s,this.params=o,this.queryParams=a,this.fragment=c,this.data=l,this.viewport=h,this.title=u,this.component=d,this.append=p,this.children=g,this.residue=f,this.version=1,this.originalInstruction=s}get root(){return this.tree.root}static create(t){var e,n,i,r,s,o,a,c;return new Vt(++jt,t.path,t.finalPath,t.context,t.instruction,t.instruction,null!==(e=t.params)&&void 0!==e?e:{},null!==(n=t.queryParams)&&void 0!==n?n:Object.freeze(new URLSearchParams),null!==(i=t.fragment)&&void 0!==i?i:null,null!==(r=t.data)&&void 0!==r?r:{},null!==(s=t.viewport)&&void 0!==s?s:null,null!==(o=t.title)&&void 0!==o?o:null,t.component,t.append,null!==(a=t.children)&&void 0!==a?a:[],null!==(c=t.residue)&&void 0!==c?c:[])}contains(t){var e,n;if(this.context===t.options.context){const i=this.children,r=t.children;for(let t=0,s=i.length;t<s;++t)for(let o=0,a=r.length;o<a&&(t+o<s&&null!==(n=null===(e=i[t+o].instruction)||void 0===e?void 0:e.contains(r[o]))&&void 0!==n&&n);++o)if(o+1===a)return!0}return this.children.some((function(e){return e.contains(t)}))}appendChild(t){this.children.push(t),t.setTree(this.tree)}appendChildren(...t){for(const e of t)this.appendChild(e)}clearChildren(){for(const t of this.children)t.clearChildren(),t.context.vpa.cancelUpdate();this.children.length=0}getTitle(t){const e=[...this.children.map((e=>e.getTitle(t))),this.getTitlePart()].filter((t=>null!==t));return 0===e.length?null:e.join(t)}getTitlePart(){return"function"==typeof this.title?this.title.call(void 0,this):this.title}computeAbsolutePath(){if(this.context.isRoot)return"";const t=this.context.parent.node.computeAbsolutePath(),e=this.instruction.toUrlComponent(!1);return t.length>0?e.length>0?[t,e].join("/"):t:e}setTree(t){this.tree=t;for(const e of this.children)e.setTree(t)}finalizeInstruction(){const t=this.children.map((t=>t.finalizeInstruction())),e=this.instruction.clone();return e.children.splice(0,e.children.length,...t),this.instruction=e}clone(){const t=new Vt(this.id,this.path,this.finalPath,this.context,this.originalInstruction,this.instruction,{...this.params},{...this.queryParams},this.fragment,{...this.data},this.viewport,this.title,this.component,this.append,this.children.map((t=>t.clone())),[...this.residue]);return t.version=this.version+1,t.context.node===this&&(t.context.node=t),t}toString(){var t,e,n,i,r;const s=[],o=null!==(n=null===(e=null===(t=this.context)||void 0===t?void 0:t.definition.component)||void 0===e?void 0:e.name)&&void 0!==n?n:"";o.length>0&&s.push(`c:'${o}'`);const a=null!==(r=null===(i=this.context)||void 0===i?void 0:i.definition.config.path)&&void 0!==r?r:"";return a.length>0&&s.push(`path:'${a}'`),this.children.length>0&&s.push(`children:[${this.children.map(String).join(",")}]`),this.residue.length>0&&s.push(`residue:${this.residue.map((function(t){return"string"==typeof t?`'${t}'`:String(t)})).join(",")}`),`RN(ctx:'${this.context.friendlyPath}',${s.join(",")})`}}class Ht{constructor(t,e,n,i){this.options=t,this.queryParams=e,this.fragment=n,this.root=i}contains(t){return this.root.contains(t)}clone(){const t=new Ht(this.options.clone(),{...this.queryParams},this.fragment,this.root.clone());return t.root.setTree(this),t}finalizeInstructions(){return new se(this.options,!0,this.root.children.map((t=>t.finalizeInstruction())),this.queryParams,this.fragment)}toString(){return this.root.toString()}}function Wt(t,e,i){const s=i.container.get(n).scopeTo("RouteTree"),o=i.root;t.options=e.options,t.queryParams=e.queryParams,t.fragment=e.fragment,e.isAbsolute&&(i=o),i===o&&(t.root.setTree(t),o.node=t.root);return s.trace(`updateRouteTree(rootCtx:%s,rt:%s,vit:%s)${i.resolved instanceof Promise?" - awaiting promise":""}`,o,t,e),r(i.resolved,(()=>qt(s,e,i,o.node)))}function qt(t,e,n,i){let o;return t.trace("updateNode(ctx:%s,node:%s)",n,i),i.queryParams=e.queryParams,i.fragment=e.fragment,o=i.context.isRoot?void 0:i.context.vpa.scheduleUpdate(i.tree.options,i),r(o,(()=>i.context===n?(i.clearChildren(),r(s(...e.children.map((e=>Dt(t,i,e,i.tree.options.append||e.append)))),(()=>s(...n.getAvailableViewportAgents("dynamic").map((e=>{const n=ie.create({component:e.viewport.default,viewport:e.viewport.name});return Dt(t,i,n,i.append)})))))):s(...i.children.map((i=>qt(t,e,n,i))))))}function Mt(t){const e=t.context,i=e.container.get(n).scopeTo("RouteTree");return i.trace(`processResidue(node:%s)${e.resolved instanceof Promise?" - awaiting promise":""}`,t),r(e.resolved,(()=>s(...t.residue.splice(0).map((e=>Dt(i,t,e,t.append))),...e.getAvailableViewportAgents("static").map((e=>{const n=ie.create({component:e.viewport.default,viewport:e.viewport.name});return Dt(i,t,n,t.append)})))))}function Dt(t,e,n,i){var r,o;switch(t.trace(`createAndAppendNodes(node:%s,vi:%s,append:${i})`,e,n),n.component.type){case 0:switch(n.component.value){case"..":e.clearChildren(),e=null!==(o=null===(r=e.context.parent)||void 0===r?void 0:r.node)&&void 0!==o?o:e;case".":return s(...n.children.map((n=>Dt(t,e,n,n.append))));default:{const r=function(t,e,n,i){const r=e.context;let s=0,o=n.component.value,a=n;for(;1===a.children.length&&(a=a.children[0],0===a.component.type);)++s,o=`${o}/${a.component.value}`;const c=r.recognize(o);if(null===c){const s=n.component.value;let o=r.container.find($,s);switch(e.tree.options.routingMode){case"configured-only":if(null===o){if(""===s)return null;throw new Error(`'${s}' did not match any configured route or registered component name at '${r.friendlyPath}' - did you forget to add '${s}' to the routes list of the route decorator of '${r.component.name}'?`)}throw new Error(`'${s}' did not match any configured route, but it does match a registered component name at '${r.friendlyPath}' - did you forget to add a @route({ path: '${s}' }) decorator to '${s}' or unintentionally set routingMode to 'configured-only'?`);case"configured-first":if(null===o){if(""===s)return null;const t=null===n.viewport||0===n.viewport.length?"default":n.viewport,e=r.getFallbackViewportAgent("dynamic",t);if(null===e)throw new Error(`'${s}' did not match any configured route or registered component name at '${r.friendlyPath}' and no fallback was provided for viewport '${t}' - did you forget to add the component '${s}' to the dependencies of '${r.component.name}' or to register it as a global dependency?`);const i=e.viewport.fallback;if(o=r.container.find($,i),null===o)throw new Error(`the requested component '${s}' and the fallback '${i}' at viewport '${t}' did not match any configured route or registered component name at '${r.friendlyPath}' - did you forget to add the component '${s}' to the dependencies of '${r.component.name}' or to register it as a global dependency?`)}return _t(t,e,n,i,o)}}const l=null===c.residue?o:o.slice(0,-(c.residue.length+1));n.component.value=l;for(let t=0;t<s;++t)n.children=n.children[0].children;return zt(t,e,n,i,c)}(t,e,n,i);if(null===r)return;return Ft(t,e,r)}}case 4:case 2:{const r=ge.resolve(n.component.value),s=_t(t,e,n,i,r.component);return Ft(t,e,s)}}}function zt(t,e,n,i,s,o=s.route.endpoint.route){const a=e.context,c=e.tree;return r(o.handler,(r=>{if(o.handler=r,null===r.redirectTo){const l=r.viewport,h=r.component,u=a.resolveViewportAgent(pt.create({viewportName:l,componentName:h.name,append:i,resolution:c.options.resolutionMode})),d=a.container.get(te).getRouteContext(u,h,u.hostController.context);return d.node=Vt.create({path:s.route.endpoint.route.path,finalPath:o.path,context:d,instruction:n,params:{...e.params,...s.route.params},queryParams:c.queryParams,fragment:c.fragment,data:r.data,viewport:l,component:h,append:i,title:r.config.title,residue:null===s.residue?[]:[ie.create(s.residue)]}),d.node.setTree(e.tree),t.trace("createConfiguredNode(vi:%s) -> %s",n,d.node),d.node}const l=Ct.parse(o.path,!1),h=Ct.parse(r.redirectTo,!1);let u,d;const p=[];switch(l.root.kind){case 2:case 4:u=l.root;break;default:throw new Error(`Unexpected expression kind ${l.root.kind}`)}switch(h.root.kind){case 2:case 4:d=h.root;break;default:throw new Error(`Unexpected expression kind ${h.root.kind}`)}let g,f,v=!1,m=!1;for(;!v||!m;){if(v)g=null;else if(4===u.kind)g=u,v=!0;else{if(4!==u.left.kind)throw new Error(`Unexpected expression kind ${u.left.kind}`);switch(g=u.left,u.right.kind){case 2:case 4:u=u.right;break;default:throw new Error(`Unexpected expression kind ${u.right.kind}`)}}if(m)f=null;else if(4===d.kind)f=d,m=!0;else{if(4!==d.left.kind)throw new Error(`Unexpected expression kind ${d.left.kind}`);switch(f=d.left,d.right.kind){case 2:case 4:d=d.right;break;default:throw new Error(`Unexpected expression kind ${d.right.kind}`)}}null!==f&&p.push(f.component.isDynamic&&(null==g?void 0:g.component.isDynamic)?s.route.params[g.component.name]:f.raw)}const w=p.filter(Boolean).join("/"),y=a.recognize(w);if(null===y){const r=w,s=a.container.find($,w);switch(c.options.routingMode){case"configured-only":if(null===s)throw new Error(`'${r}' did not match any configured route or registered component name at '${a.friendlyPath}' - did you forget to add '${r}' to the routes list of the route decorator of '${a.component.name}'?`);throw new Error(`'${r}' did not match any configured route, but it does match a registered component name at '${a.friendlyPath}' - did you forget to add a @route({ path: '${r}' }) decorator to '${r}' or unintentionally set routingMode to 'configured-only'?`);case"configured-first":if(null===s)throw new Error(`'${r}' did not match any configured route or registered component name at '${a.friendlyPath}' - did you forget to add the component '${r}' to the dependencies of '${a.component.name}' or to register it as a global dependency?`);return _t(t,e,n,i,s)}}return zt(t,e,n,i,s,y.route.endpoint.route)}))}function _t(t,e,n,i,r){var s;const o=e.context,a=e.tree,c=null!==(s=n.viewport)&&void 0!==s?s:"default",l=o.resolveViewportAgent(pt.create({viewportName:c,componentName:r.name,append:i,resolution:a.options.resolutionMode})),h=o.container.get(te).getRouteContext(l,r,l.hostController.context),u=ge.resolve(r);return h.node=Vt.create({path:r.name,finalPath:r.name,context:h,instruction:n,params:{...o.node.params,...n.params},queryParams:a.queryParams,fragment:a.fragment,data:u.data,viewport:c,component:r,append:i,title:u.config.title,residue:[...n.children]}),h.node.setTree(o.node.tree),t.trace("createDirectNode(vi:%s) -> %s",n,h.node),h.node}function Ft(t,e,n){return r(n,(n=>(t.trace("appendNode($childNode:%s)",n),e.appendChild(n),n.context.vpa.scheduleUpdate(e.tree.options,n))))}const Bt="au-nav-id";function Yt(t){return o(t)&&!0===Object.prototype.hasOwnProperty.call(t,"au-nav-id")}function Kt(t,e){return{...t,"au-nav-id":e}}function Gt(t,e){return"function"==typeof e?e(t):e}class Jt{constructor(t,e,n,i,r,s,o,a,c,l){this.useUrlFragmentHash=t,this.useHref=e,this.statefulHistoryLength=n,this.routingMode=i,this.swapStrategy=r,this.resolutionMode=s,this.queryParamsStrategy=o,this.fragmentStrategy=a,this.historyStrategy=c,this.sameUrlStrategy=l}static get DEFAULT(){return Jt.create({})}static create(t){var e,n,i,r,s,o,a,c,l,h;return new Jt(null!==(e=t.useUrlFragmentHash)&&void 0!==e&&e,null===(n=t.useHref)||void 0===n||n,null!==(i=t.statefulHistoryLength)&&void 0!==i?i:0,null!==(r=t.routingMode)&&void 0!==r?r:"configured-first",null!==(s=t.swapStrategy)&&void 0!==s?s:"sequential-remove-first",null!==(o=t.resolutionMode)&&void 0!==o?o:"dynamic",null!==(a=t.queryParamsStrategy)&&void 0!==a?a:"overwrite",null!==(c=t.fragmentStrategy)&&void 0!==c?c:"overwrite",null!==(l=t.historyStrategy)&&void 0!==l?l:"push",null!==(h=t.sameUrlStrategy)&&void 0!==h?h:"ignore")}getQueryParamsStrategy(t){return Gt(t,this.queryParamsStrategy)}getFragmentStrategy(t){return Gt(t,this.fragmentStrategy)}getHistoryStrategy(t){return Gt(t,this.historyStrategy)}getSameUrlStrategy(t){return Gt(t,this.sameUrlStrategy)}stringifyProperties(){return[["routingMode","mode"],["swapStrategy","swap"],["resolutionMode","resolution"],["queryParamsStrategy","queryParams"],["fragmentStrategy","fragment"],["historyStrategy","history"],["sameUrlStrategy","sameUrl"]].map((([t,e])=>{const n=this[t];return`${e}:${"function"==typeof n?n:`'${n}'`}`})).join(",")}clone(){return new Jt(this.useUrlFragmentHash,this.useHref,this.statefulHistoryLength,this.routingMode,this.swapStrategy,this.resolutionMode,this.queryParamsStrategy,this.fragmentStrategy,this.historyStrategy,this.sameUrlStrategy)}toString(){return`RO(${this.stringifyProperties()})`}}class Qt extends Jt{constructor(t,e,n,i,r,s,o,a){super(t.useUrlFragmentHash,t.useHref,t.statefulHistoryLength,t.routingMode,t.swapStrategy,t.resolutionMode,t.queryParamsStrategy,t.fragmentStrategy,t.historyStrategy,t.sameUrlStrategy),this.title=e,this.titleSeparator=n,this.append=i,this.context=r,this.queryParams=s,this.fragment=o,this.state=a}static get DEFAULT(){return Qt.create({})}static create(t){var e,n,i,r,s,o,a;return new Qt(Jt.create(t),null!==(e=t.title)&&void 0!==e?e:null,null!==(n=t.titleSeparator)&&void 0!==n?n:" | ",null!==(i=t.append)&&void 0!==i&&i,null!==(r=t.context)&&void 0!==r?r:null,null!==(s=t.queryParams)&&void 0!==s?s:null,null!==(o=t.fragment)&&void 0!==o?o:"",null!==(a=t.state)&&void 0!==a?a:null)}clone(){return new Qt(super.clone(),this.title,this.titleSeparator,this.append,this.context,{...this.queryParams},this.fragment,null===this.state?null:{...this.state})}toString(){return`NO(${super.stringifyProperties()})`}}class Zt{constructor(t,e,n,i,r,s){this.id=t,this.instructions=e,this.trigger=n,this.options=i,this.prevNavigation=r,this.finalInstructions=s}static create(t){return new Zt(t.id,t.instructions,t.trigger,t.options,t.prevNavigation,t.finalInstructions)}toString(){return`N(id:${this.id},instructions:${this.instructions},trigger:'${this.trigger}')`}}class Xt{constructor(t,e,n,i,r,s,o,a,c,l,h,u,d,p,g){this.id=t,this.prevInstructions=e,this.instructions=n,this.finalInstructions=i,this.instructionsChanged=r,this.trigger=s,this.options=o,this.managedState=a,this.previousRouteTree=c,this.routeTree=l,this.promise=h,this.resolve=u,this.reject=d,this.guardsResult=p,this.error=g}static create(t){return new Xt(t.id,t.prevInstructions,t.instructions,t.finalInstructions,t.instructionsChanged,t.trigger,t.options,t.managedState,t.previousRouteTree,t.routeTree,t.promise,t.resolve,t.reject,t.guardsResult,void 0)}run(t,e){if(!0===this.guardsResult)try{const n=t();n instanceof Promise?n.then(e).catch((t=>{this.handleError(t)})):e(n)}catch(t){this.handleError(t)}}handleError(t){this.reject(this.error=t)}toString(){return`T(id:${this.id},trigger:'${this.trigger}',instructions:${this.instructions},options:${this.options})`}}const te=t.createInterface("IRouter",(t=>t.singleton(ee)));let ee=class{constructor(t,e,n,i,r){this.container=t,this.p=e,this.logger=n,this.events=i,this.locationMgr=r,this._ctx=null,this._routeTree=null,this._currentTr=null,this.options=Jt.DEFAULT,this.navigated=!1,this.navigationId=0,this.lastSuccessfulNavigation=null,this.activeNavigation=null,this.instructions=se.create(""),this.nextTr=null,this.locationChangeSubscription=null,this.vpaLookup=new Map,this.logger=n.root.scopeTo("Router")}get ctx(){let t=this._ctx;if(null===t){if(!this.container.has(me,!0))throw new Error("Root RouteContext is not set. Did you forget to register RouteConfiguration, or try to navigate before calling Aurelia.start()?");t=this._ctx=this.container.get(me)}return t}get routeTree(){let t=this._routeTree;if(null===t){const e=this.ctx;t=this._routeTree=new Ht(Qt.create({...this.options}),Object.freeze(new URLSearchParams),null,Vt.create({path:"",finalPath:"",context:e,instruction:null,component:e.definition.component,append:!1}))}return t}get currentTr(){let t=this._currentTr;return null===t&&(t=this._currentTr=Xt.create({id:0,prevInstructions:this.instructions,instructions:this.instructions,finalInstructions:this.instructions,instructionsChanged:!0,trigger:"api",options:Qt.DEFAULT,managedState:null,previousRouteTree:this.routeTree.clone(),routeTree:this.routeTree,resolve:null,reject:null,promise:null,guardsResult:!0,error:void 0})),t}set currentTr(t){this._currentTr=t}resolveContext(t){return we.resolve(this.ctx,t)}start(t,e){if(this.options=Jt.create(t),this.locationMgr.startListening(),this.locationChangeSubscription=this.events.subscribe("au:router:location-change",(t=>{this.p.taskQueue.queueTask((()=>{const e=Yt(t.state)?t.state:null,n=Qt.create({...this.options,historyStrategy:"replace"}),i=se.create(t.url,n);this.enqueue(i,t.trigger,e,null)}))})),!this.navigated&&e)return this.load(this.locationMgr.getPath(),{historyStrategy:"replace"})}stop(){var t;this.locationMgr.stopListening(),null===(t=this.locationChangeSubscription)||void 0===t||t.dispose()}load(t,e){const n=this.createViewportInstructions(t,e);return this.logger.trace("load(instructions:%s)",n),this.enqueue(n,"api",null,null)}isActive(t,e){const n=this.resolveContext(e),i=this.createViewportInstructions(t,{context:n});return this.logger.trace("isActive(instructions:%s,ctx:%s)",i,n),this.routeTree.contains(i)}getRouteContext(t,e,i){const r=i.container,s=r.get(n).scopeTo("RouteContext"),o=ge.resolve(e.Type);let a=this.vpaLookup.get(t);void 0===a&&this.vpaLookup.set(t,a=new WeakMap);let c=a.get(o);if(void 0===c){s.trace("creating new RouteContext for %s",o);const n=r.has(me,!0)?r.get(me):null;a.set(o,c=new we(t,n,e,o,r))}else s.trace("returning existing RouteContext for %s",o),null!==t&&(c.vpa=t);return c}createViewportInstructions(t,e){return"string"==typeof t&&(t=this.locationMgr.removeBaseHref(t)),se.create(t,this.getNavigationOptions(e))}enqueue(t,e,n,i){const r=this.currentTr;if("api"!==e&&"api"===r.trigger&&r.instructions.equals(t))return this.logger.debug("Ignoring navigation triggered by '%s' because it is the same URL as the previous navigation which was triggered by 'api'.",e),!0;let s,o,a;null===i?a=new Promise((function(t,e){s=t,o=e})):(this.logger.debug("Reusing promise/resolve/reject from the previously failed transition %s",i),a=i.promise,s=i.resolve,o=i.reject);const c=this.nextTr=Xt.create({id:++this.navigationId,trigger:e,managedState:n,prevInstructions:r.finalInstructions,finalInstructions:t,instructionsChanged:!r.finalInstructions.equals(t),instructions:t,options:t.options,promise:a,resolve:s,reject:o,previousRouteTree:this.routeTree,routeTree:this._routeTree=this.routeTree.clone(),guardsResult:!0,error:void 0});if(this.logger.debug("Scheduling transition: %s",c),null===this.activeNavigation)try{this.run(c)}catch(t){c.handleError(t)}return c.promise.then((t=>(this.logger.debug("Transition succeeded: %s",c),t))).catch((t=>{throw this.logger.error("Navigation failed: %s",c,t),t}))}run(t){this.currentTr=t,this.nextTr=null;const e=null===this.lastSuccessfulNavigation?null:Zt.create({...this.lastSuccessfulNavigation,prevNavigation:null});this.activeNavigation=Zt.create({id:t.id,instructions:t.instructions,trigger:t.trigger,options:t.options,prevNavigation:e,finalInstructions:t.finalInstructions});const n=this.resolveContext(t.options.context);return!this.navigated||t.instructions.children.length!==n.node.children.length||t.instructions.children.some(((t,e)=>{var i,r;return!(null!==(r=null===(i=n.node.children[e])||void 0===i?void 0:i.originalInstruction.equals(t))&&void 0!==r&&r)}))||"reload"===t.options.getSameUrlStrategy(this.instructions)?(this.logger.trace("run(tr:%s) - processing route",t),this.events.publish(new it(t.id,t.instructions,t.trigger,t.managedState)),null!==this.nextTr?(this.logger.debug("run(tr:%s) - aborting because a new transition was queued in response to the NavigationStartEvent",t),this.run(this.nextTr)):(this.activeNavigation=Zt.create({...this.activeNavigation,finalInstructions:t.finalInstructions}),void t.run((()=>(this.logger.trace("run() - compiling route tree: %s",t.finalInstructions),Wt(t.routeTree,t.finalInstructions,n))),(()=>{const e=t.previousRouteTree.root.children,n=t.routeTree.root.children,i=W(e,n);H.start((n=>{this.logger.trace(`run() - invoking canUnload on ${e.length} nodes`);for(const i of e)i.context.vpa.canUnload(t,n)})).continueWith((e=>{!0!==t.guardsResult&&(e.push(),this.cancelNavigation(t))})).continueWith((e=>{this.logger.trace(`run() - invoking canLoad on ${n.length} nodes`);for(const i of n)i.context.vpa.canLoad(t,e)})).continueWith((e=>{!0!==t.guardsResult&&(e.push(),this.cancelNavigation(t))})).continueWith((n=>{this.logger.trace(`run() - invoking unload on ${e.length} nodes`);for(const i of e)i.context.vpa.unload(t,n)})).continueWith((e=>{this.logger.trace(`run() - invoking load on ${n.length} nodes`);for(const i of n)i.context.vpa.load(t,e)})).continueWith((e=>{this.logger.trace(`run() - invoking swap on ${i.length} nodes`);for(const n of i)n.context.vpa.swap(t,e)})).continueWith((()=>{this.logger.trace("run() - finalizing transition"),i.forEach((function(t){t.context.vpa.endTransition()})),this.navigated=!0,this.instructions=t.finalInstructions=t.routeTree.finalizeInstructions(),this.events.publish(new rt(t.id,t.instructions,this.instructions)),this.lastSuccessfulNavigation=this.activeNavigation,this.activeNavigation=null,this.applyHistoryState(t),t.resolve(!0),this.runNextTransition(t)})).start()})))):(this.logger.trace("run(tr:%s) - NOT processing route",t),this.navigated=!0,this.activeNavigation=null,t.resolve(!1),void this.runNextTransition(t))}applyHistoryState(t){const e=t.finalInstructions.toUrl(this.options.useUrlFragmentHash);switch(t.options.getHistoryStrategy(this.instructions)){case"none":break;case"push":this.locationMgr.pushState(Kt(t.options.state,t.id),this.updateTitle(t),e);break;case"replace":this.locationMgr.replaceState(Kt(t.options.state,t.id),this.updateTitle(t),e)}}getTitle(t){var e,n;switch(typeof t.options.title){case"function":return null!==(e=t.options.title.call(void 0,t.routeTree.root))&&void 0!==e?e:"";case"string":return t.options.title;default:return null!==(n=t.routeTree.root.getTitle(t.options.titleSeparator))&&void 0!==n?n:""}}updateTitle(t){const e=this.getTitle(t);return e.length>0&&(this.p.document.title=e),this.p.document.title}cancelNavigation(t){this.logger.trace("cancelNavigation(tr:%s)",t);W(t.previousRouteTree.root.children,t.routeTree.root.children).forEach((function(t){t.context.vpa.cancelUpdate()})),this.activeNavigation=null,this.instructions=t.prevInstructions,this._routeTree=t.previousRouteTree,this.events.publish(new st(t.id,t.instructions,`guardsResult is ${t.guardsResult}`)),!1===t.guardsResult?(t.resolve(!1),this.runNextTransition(t)):r(this.enqueue(t.guardsResult,"api",t.managedState,t),(()=>{this.logger.trace("cancelNavigation(tr:%s) - finished redirect",t)}))}runNextTransition(t){null!==this.nextTr&&(this.logger.trace("runNextTransition(tr:%s) -> scheduling nextTransition: %s",t,this.nextTr),this.p.taskQueue.queueTask((()=>{const t=this.nextTr;if(null!==t)try{this.run(t)}catch(e){t.handleError(e)}})))}getNavigationOptions(t){return Qt.create({...this.options,...t})}};ee=Q([Z(0,a),Z(1,b),Z(2,n),Z(3,tt),Z(4,ht)],ee);const ne=t.createInterface("IViewportInstruction");class ie{constructor(t,e,n,i,r,s,o,a){this.context=t,this.append=e,this.open=n,this.close=i,this.component=r,this.viewport=s,this.params=o,this.children=a}static create(t,e){var n,i,r,s,o,a,c,l,h;if(t instanceof ie)return t;if(B(t)){const u=ae.create(t.component),d=null!==(i=null===(n=t.children)||void 0===n?void 0:n.map(ie.create))&&void 0!==i?i:[];return new ie(null!==(s=null!==(r=t.context)&&void 0!==r?r:e)&&void 0!==s?s:null,null!==(o=t.append)&&void 0!==o&&o,null!==(a=t.open)&&void 0!==a?a:0,null!==(c=t.close)&&void 0!==c?c:0,u,null!==(l=t.viewport)&&void 0!==l?l:null,null!==(h=t.params)&&void 0!==h?h:null,d)}const u=ae.create(t);return new ie(null!=e?e:null,!1,0,0,u,null,null,[])}contains(t){const e=this.children,n=t.children;if(e.length<n.length)return!1;if(!this.component.equals(t.component))return!1;for(let t=0,i=n.length;t<i;++t)if(!e[t].contains(n[t]))return!1;return!0}equals(t){const e=this.children,n=t.children;if(e.length!==n.length)return!1;if(!this.component.equals(t.component)||this.viewport!==t.viewport||!J(this.params,t.params))return!1;for(let t=0,i=e.length;t<i;++t)if(!e[t].equals(n[t]))return!1;return!0}clone(){return new ie(this.context,this.append,this.open,this.close,this.component.clone(),this.viewport,null===this.params?null:{...this.params},[...this.children])}toUrlComponent(t=!0){const e=this.component.toUrlComponent(),n=null===this.params||0===Object.keys(this.params).length?"":`(${function(t){const e=Object.keys(t),n=Array(e.length),i=[],r=[];for(const t of e)c(t)?i.push(Number(t)):r.push(t);for(let s=0;s<e.length;++s){const e=i.indexOf(s);if(e>-1)n[s]=t[s],i.splice(e,1);else{const e=r.shift();n[s]=`${e}=${t[e]}`}}return n.join(",")}(this.params)})`,i=0===e.length||null===this.viewport||0===this.viewport.length?"":`@${this.viewport}`,r=`${"(".repeat(this.open)}${e}${n}${i}${")".repeat(this.close)}`,s=t?this.children.map((t=>t.toUrlComponent())).join("+"):"";return r.length>0?s.length>0?[r,s].join("/"):r:s}toString(){return`VPI(${[`c:${this.component}`,null===this.viewport||0===this.viewport.length?"":`viewport:${this.viewport}`,0===this.children.length?"":`children:[${this.children.map(String).join(",")}]`].filter(Boolean).join(",")})`}}const re=function(){let t=0;const e=new Map;return function(n){let i=e.get(n);return void 0===i&&e.set(n,i=++t),i}}();class se{constructor(t,e,n,i,r){this.options=t,this.isAbsolute=e,this.children=n,this.queryParams=i,this.fragment=r}static create(t,e){const n=Qt.create({...e});if(t instanceof se)return new se(n,t.isAbsolute,t.children.map((t=>ie.create(t,n.context))),t.queryParams,t.fragment);if(t instanceof Array)return new se(n,!1,t.map((t=>ie.create(t,n.context))),Object.freeze(new URLSearchParams),null);if("string"==typeof t){return Ct.parse(t,n.useUrlFragmentHash).toInstructionTree(n)}return new se(n,!1,[ie.create(t,n.context)],Object.freeze(new URLSearchParams),null)}equals(t){const e=this.children,n=t.children;if(e.length!==n.length)return!1;for(let t=0,i=e.length;t<i;++t)if(!e[t].equals(n[t]))return!1;return!0}toUrl(t=!1){var e;let n,i;t?(n="",i=`#${this.toPath()}`):(n=this.toPath(),i=null!==(e=this.fragment)&&void 0!==e?e:"");let r=this.queryParams.toString();r=""===r?"":`?${r}`;return`${n}${i}${r}`}toPath(){return this.children.map((t=>t.toUrlComponent())).join("+")}toString(){return`[${this.children.map(String).join(",")}]`}}var oe;!function(t){t[t.string=0]="string",t[t.ViewportInstruction=1]="ViewportInstruction",t[t.CustomElementDefinition=2]="CustomElementDefinition",t[t.Promise=3]="Promise",t[t.IRouteViewModel=4]="IRouteViewModel"}(oe||(oe={}));class ae{constructor(t,e){this.type=t,this.value=e}static create(t){if(t instanceof ae)return t;if("string"==typeof t)return new ae(0,t);if(o(t)){if("function"==typeof t){const e=$.getDefinition(t);return new ae(2,e)}if(t instanceof Promise)return new ae(3,t);if(B(t)){const e=ie.create(t);return new ae(1,e)}if(v(t))return new ae(4,t);if(t instanceof S)return new ae(2,t);if(z(t)){const e=$.define(t),n=$.getDefinition(e);return new ae(2,n)}throw new Error(`Invalid component ${q(t)}: must be either a class, a custom element ViewModel, or a (partial) custom element definition`)}Y("function/class or object","",t)}equals(t){switch(this.type){case 2:case 4:case 3:case 0:return this.type===t.type&&this.value===t.value;case 1:return this.type===t.type&&this.value.equals(t.value)}}clone(){return new ae(this.type,this.value)}toUrlComponent(){switch(this.type){case 2:return this.value.name;case 4:case 3:return`au$obj${re(this.value)}`;case 1:return this.value.toUrlComponent();case 0:return this.value}}toString(){switch(this.type){case 2:return`CEDef(name:'${this.value.name}')`;case 3:return"Promise";case 4:return`VM(name:'${$.getDefinition(this.value.constructor).name}')`;case 1:return this.value.toString();case 0:return`'${this.value}'`}}}const ce=u;function le(t,e){return J(t.params,e.params)?"none":"invoke-lifecycles"}class he{constructor(t,e,n,i,r,s,o,a,c){this.id=t,this.path=e,this.title=n,this.redirectTo=i,this.caseSensitive=r,this.transitionPlan=s,this.viewport=o,this.data=a,this.routes=c}static create(t,e){var n,i,r,s,o,a,c,l,h,u,d,p,g,f,v,m,w,y,x,$,b,S,k,C;if("string"==typeof t||t instanceof Array){const h=t,u=null!==(n=null==e?void 0:e.redirectTo)&&void 0!==n?n:null,d=null!==(i=null==e?void 0:e.caseSensitive)&&void 0!==i&&i,p=null!==(r=null==e?void 0:e.id)&&void 0!==r?r:h instanceof Array?h[0]:h,g=null!==(s=null==e?void 0:e.title)&&void 0!==s?s:null,f=null!==(o=null==e?void 0:e.transitionPlan)&&void 0!==o?o:le,v=null!==(a=null==e?void 0:e.viewport)&&void 0!==a?a:null,m=null!==(c=null==e?void 0:e.data)&&void 0!==c?c:{},w=null!==(l=null==e?void 0:e.routes)&&void 0!==l?l:ce;return new he(p,h,g,u,d,f,v,m,w)}if("object"==typeof t){const n=t;K(n,"");const i=null!==(u=null!==(h=n.path)&&void 0!==h?h:null==e?void 0:e.path)&&void 0!==u?u:null,r=null!==(p=null!==(d=n.title)&&void 0!==d?d:null==e?void 0:e.title)&&void 0!==p?p:null,s=null!==(f=null!==(g=n.redirectTo)&&void 0!==g?g:null==e?void 0:e.redirectTo)&&void 0!==f?f:null,o=null!==(m=null!==(v=n.caseSensitive)&&void 0!==v?v:null==e?void 0:e.caseSensitive)&&void 0!==m&&m,a=null!==(y=null!==(w=n.id)&&void 0!==w?w:null==e?void 0:e.id)&&void 0!==y?y:i instanceof Array?i[0]:i,c=null!==($=null!==(x=n.transitionPlan)&&void 0!==x?x:null==e?void 0:e.transitionPlan)&&void 0!==$?$:le,l=null!==(S=null!==(b=n.viewport)&&void 0!==b?b:null==e?void 0:e.viewport)&&void 0!==S?S:null,T={...null==e?void 0:e.data,...n.data},P=[...null!==(k=n.routes)&&void 0!==k?k:ce,...null!==(C=null==e?void 0:e.routes)&&void 0!==C?C:ce];return new he(a,i,r,s,o,c,l,T,P)}Y("string, function/class or object","",t)}static configure(t,e){const n=he.create(t,e);return l.define(de.name,n,e),e}static getConfig(t){return l.hasOwn(de.name,t)||de.configure({},t),l.getOwn(de.name,t)}saveTo(t){l.define(de.name,this,t)}}class ue extends he{constructor(t,e,n,i,r,s,o,a,c,l){super(t,e,n,i,r,s,o,a,c),this.component=l}}const de={name:h.resource.keyFor("route"),isConfigured:t=>l.hasOwn(de.name,t),configure(t,e){const n=he.create(t,e);return l.define(de.name,n,e),e},getConfig:t=>(de.isConfigured(t)||de.configure({},t),l.getOwn(de.name,t))};function pe(t){return function(e){return de.configure(t,e)}}class ge{constructor(t,e){var n,i,r,s,o,a;this.config=t,this.component=e,this.hasExplicitPath=null!==t.path,this.caseSensitive=t.caseSensitive,this.path=M(null!==(n=t.path)&&void 0!==n?n:e.name),this.redirectTo=null!==(i=t.redirectTo)&&void 0!==i?i:null,this.viewport=null!==(r=t.viewport)&&void 0!==r?r:"default",this.id="string"==typeof(a=null!==(s=t.id)&&void 0!==s?s:this.path)?a:a[0],this.data=null!==(o=t.data)&&void 0!==o?o:{}}static resolve(t,e){return F(t)?new ge(t,null):r(this.resolveCustomElementDefinition(t,e),(e=>{const n=_(t)?{...de.getConfig(e.Type),...t}:de.getConfig(e.Type);if(l.hasOwn(de.name,e)){let t=l.getOwn(de.name,e);t.config!==n&&(t=new ge(n,e),l.define(de.name,t,e))}else{const t=new ge(n,e);l.define(de.name,t,e)}return l.getOwn(de.name,e)}))}static resolveCustomElementDefinition(t,e){if(_(t))return this.resolveCustomElementDefinition(t.component,e);const n=ae.create(t);switch(n.type){case 0:{if(void 0===e)throw new Error("When retrieving the RouteDefinition for a component name, a RouteContext (that can resolve it) must be provided");const t=e.container.find($,n.value);if(null===t)throw new Error(`Could not find a CustomElement named '${n.value}' in the current container scope of ${e}. This means the component is neither registered at Aurelia startup nor via the 'dependencies' decorator or static property.`);return t}case 2:return n.value;case 4:return $.getDefinition(n.value.constructor);case 3:if(void 0===e)throw new Error("RouteContext must be provided when resolving an imported module");return e.resolveLazy(n.value)}}register(t){var e;null===(e=this.component)||void 0===e||e.register(t)}toUrlComponent(){return"not-implemented"}toString(){const t=null===this.config.path?"null":`'${this.config.path}'`;return null!==this.component?`RD(config.path:${t},c.name:'${this.component.name}')`:`RD(config.path:${t},redirectTo:'${this.redirectTo}')`}}const fe=new WeakMap;class ve{constructor(t,e,i,r,s){var o,a,c,l;this.instance=t,this.controller=e,this.definition=i,this.routeNode=r,this.ctx=s,this.logger=s.container.get(n).scopeTo(`ComponentAgent<${s.friendlyPath}>`),this.logger.trace("constructor()");const h=e.lifecycleHooks;this.canLoadHooks=(null!==(o=h.canLoad)&&void 0!==o?o:[]).map((t=>t.instance)),this.loadHooks=(null!==(a=h.load)&&void 0!==a?a:[]).map((t=>t.instance)),this.canUnloadHooks=(null!==(c=h.canUnload)&&void 0!==c?c:[]).map((t=>t.instance)),this.unloadHooks=(null!==(l=h.unload)&&void 0!==l?l:[]).map((t=>t.instance)),this.hasCanLoad="canLoad"in t,this.hasLoad="load"in t,this.hasCanUnload="canUnload"in t,this.hasUnload="unload"in t}static for(t,e,n,i){let r=fe.get(t);if(void 0===r){const s=i.container,o=ge.resolve(t.constructor),a=x.forCustomElement(s.get(k),s,s,t,e.host,null);fe.set(t,r=new ve(t,a,o,n,i))}return r}activate(t,e,n){if(null===t)return this.logger.trace("activate() - initial"),this.controller.activate(this.controller,e,n);this.logger.trace("activate()"),this.controller.activate(t,e,n)}deactivate(t,e,n){if(null===t)return this.logger.trace("deactivate() - initial"),this.controller.deactivate(this.controller,e,n);this.logger.trace("deactivate()"),this.controller.deactivate(t,e,n)}dispose(){this.logger.trace("dispose()"),this.controller.dispose()}canUnload(t,e,n){this.logger.trace(`canUnload(next:%s) - invoking ${this.canUnloadHooks.length} hooks`,e),n.push();for(const i of this.canUnloadHooks)t.run((()=>(n.push(),i.canUnload(this.instance,e,this.routeNode))),(e=>{!0===t.guardsResult&&!0!==e&&(t.guardsResult=!1),n.pop()}));this.hasCanUnload&&t.run((()=>(n.push(),this.instance.canUnload(e,this.routeNode))),(e=>{!0===t.guardsResult&&!0!==e&&(t.guardsResult=!1),n.pop()})),n.pop()}canLoad(t,e,n){this.logger.trace(`canLoad(next:%s) - invoking ${this.canLoadHooks.length} hooks`,e),n.push();for(const i of this.canLoadHooks)t.run((()=>(n.push(),i.canLoad(this.instance,e.params,e,this.routeNode))),(e=>{!0===t.guardsResult&&!0!==e&&(t.guardsResult=!1!==e&&se.create(e)),n.pop()}));this.hasCanLoad&&t.run((()=>(n.push(),this.instance.canLoad(e.params,e,this.routeNode))),(e=>{!0===t.guardsResult&&!0!==e&&(t.guardsResult=!1!==e&&se.create(e)),n.pop()})),n.pop()}unload(t,e,n){this.logger.trace(`unload(next:%s) - invoking ${this.unloadHooks.length} hooks`,e),n.push();for(const i of this.unloadHooks)t.run((()=>(n.push(),i.unload(this.instance,e,this.routeNode))),(()=>{n.pop()}));this.hasUnload&&t.run((()=>(n.push(),this.instance.unload(e,this.routeNode))),(()=>{n.pop()})),n.pop()}load(t,e,n){this.logger.trace(`load(next:%s) - invoking ${this.loadHooks.length} hooks`,e),n.push();for(const i of this.loadHooks)t.run((()=>(n.push(),i.load(this.instance,e.params,e,this.routeNode))),(()=>{n.pop()}));this.hasLoad&&t.run((()=>(n.push(),this.instance.load(e.params,e,this.routeNode))),(()=>{n.pop()})),n.pop()}toString(){return`CA(ctx:'${this.ctx.friendlyPath}',c:'${this.definition.component.name}')`}}const me=t.createInterface("IRouteContext");class we{constructor(t,e,i,r,s){var o;this.parent=e,this.component=i,this.definition=r,this.parentContainer=s,this.childViewportAgents=[],this.childRoutes=[],this._resolved=null,this._allResolved=null,this.prevNode=null,this._node=null,this._vpa=null,this._vpa=t,null===e?(this.root=this,this.path=[this],this.friendlyPath=i.name):(this.root=e.root,this.path=[...e.path,this],this.friendlyPath=`${e.friendlyPath}/${i.name}`),this.logger=s.get(n).scopeTo(`RouteContext<${this.friendlyPath}>`),this.logger.trace("constructor()"),this.moduleLoader=s.get(d);const a=this.container=s.createChild();a.registerResolver(C,this.hostControllerProvider=new p,!0);const c=new p;a.registerResolver(me,c,!0),c.prepare(this),a.register(r),a.register(...i.dependencies),this.recognizer=new V;const l=[],h=[];for(const t of r.config.routes)if(t instanceof Promise){const e=this.addRoute(t);l.push(e),h.push(e)}else{const e=ge.resolve(t,this);if(e instanceof Promise){if(!_(t)||null==t.path)throw new Error("Invalid route config. When the component property is a lazy import, the path must be specified. To use lazy loading without specifying the path (e.g. in direct routing), pass the import promise as a direct value to the routes array instead of providing it as the component property on an object literal.");{for(const n of M(t.path))this.$addRoute(n,null!==(o=t.caseSensitive)&&void 0!==o&&o,e);const n=this.childRoutes.length,i=e.then((t=>this.childRoutes[n]=t));this.childRoutes.push(i),h.push(i.then(g))}}else{for(const t of e.path)this.$addRoute(t,e.caseSensitive,e);this.childRoutes.push(e)}}l.length>0&&(this._resolved=Promise.all(l).then((()=>{this._resolved=null}))),h.length>0&&(this._allResolved=Promise.all(h).then((()=>{this._allResolved=null})))}get id(){return this.container.id}get isRoot(){return null===this.parent}get depth(){return this.path.length-1}get resolved(){return this._resolved}get allResolved(){return this._allResolved}get node(){const t=this._node;if(null===t)throw new Error(`Invariant violation: RouteNode should be set immediately after the RouteContext is created. Context: ${this}`);return t}set node(t){(this.prevNode=this._node)!==t&&(this._node=t,this.logger.trace("Node changed from %s to %s",this.prevNode,t))}get vpa(){const t=this._vpa;if(null===t)throw new Error(`RouteContext has no ViewportAgent: ${this}`);return t}set vpa(t){if(null==t)throw new Error(`Cannot set ViewportAgent to ${t} for RouteContext: ${this}`);const e=this._vpa;e!==t&&(this._vpa=t,this.logger.trace("ViewportAgent changed from %s to %s",e,t))}static setRoot(t){const e=t.get(n).scopeTo("RouteContext");t.has(k,!0)||ye(new Error("The provided container has no registered IAppRoot. RouteContext.setRoot can only be used after Aurelia.app was called, on a container that is within that app's component tree."),e),t.has(me,!0)&&ye(new Error('A root RouteContext is already registered. A possible cause is the RouterConfiguration being registered more than once in the same container tree. If you have a multi-rooted app, make sure you register RouterConfiguration only in the "forked" containers and not in the common root.'),e);const{controller:i}=t.get(k);void 0===i&&ye(new Error("The provided IAppRoot does not (yet) have a controller. A possible cause is calling this API manually before Aurelia.start() is called"),e);const r=t.get(te),s=r.getRouteContext(null,i.context.definition,i.context);t.register(f.instance(me,s)),s.node=r.routeTree.root}static resolve(t,e){const i=t.container,r=i.get(n).scopeTo("RouteContext");if(null==e)return r.trace("resolve(context:%s) - returning root RouteContext",e),t;if(e instanceof we)return r.trace("resolve(context:%s) - returning provided RouteContext",e),e;if(e instanceof i.get(b).Node)try{const t=$.for(e,{searchParents:!0});return r.trace(`resolve(context:Node(nodeName:'${e.nodeName}'),controller:'${t.context.definition.name}') - resolving RouteContext from controller's RenderContext`),t.container.get(me)}catch(t){throw r.error(`Failed to resolve RouteContext from Node(nodeName:'${e.nodeName}')`,t),t}if(v(e)){const t=e.$controller;return r.trace(`resolve(context:CustomElementViewModel(name:'${t.context.definition.name}')) - resolving RouteContext from controller's RenderContext`),t.container.get(me)}if(T(e)){const t=e;return r.trace(`resolve(context:CustomElementController(name:'${t.context.definition.name}')) - resolving RouteContext from controller's RenderContext`),t.container.get(me)}ye(new Error(`Invalid context type: ${Object.prototype.toString.call(e)}`),r)}dispose(){this.container.dispose()}resolveViewportAgent(t){this.logger.trace("resolveViewportAgent(req:%s)",t);const e=this.childViewportAgents.find((e=>e.handles(t)));if(void 0===e)throw new Error(`Failed to resolve ${t} at:\n${this.printTree()}`);return e}getAvailableViewportAgents(t){return this.childViewportAgents.filter((e=>e.isAvailable(t)))}getFallbackViewportAgent(t,e){var n;return null!==(n=this.childViewportAgents.find((n=>n.isAvailable(t)&&n.viewport.name===e&&n.viewport.fallback.length>0)))&&void 0!==n?n:null}createComponentAgent(t,e){this.logger.trace("createComponentAgent(routeNode:%s)",e),this.hostControllerProvider.prepare(t);const n=ge.resolve(e.component),i=this.container.get(n.component.key),r=ve.for(i,t,e,this);return this.hostControllerProvider.dispose(),r}registerViewport(t){const e=ft.for(t,this);return this.childViewportAgents.includes(e)?this.logger.trace("registerViewport(agent:%s) -> already registered, so skipping",e):(this.logger.trace("registerViewport(agent:%s) -> adding",e),this.childViewportAgents.push(e)),e}unregisterViewport(t){const e=ft.for(t,this);this.childViewportAgents.includes(e)?(this.logger.trace("unregisterViewport(agent:%s) -> unregistering",e),this.childViewportAgents.splice(this.childViewportAgents.indexOf(e),1)):this.logger.trace("unregisterViewport(agent:%s) -> not registered, so skipping",e)}recognize(t){var e;this.logger.trace(`recognize(path:'${t}')`);const n=this.recognizer.recognize(t);if(null===n)return null;let i;return Reflect.has(n.params,"au$residue")?(i=null!==(e=n.params.au$residue)&&void 0!==e?e:null,Reflect.deleteProperty(n.params,"au$residue")):i=null,new $e(n,i)}addRoute(t){return this.logger.trace(`addRoute(routeable:'${t}')`),r(ge.resolve(t,this),(t=>{for(const e of t.path)this.$addRoute(e,t.caseSensitive,t);this.childRoutes.push(t)}))}$addRoute(t,e,n){this.recognizer.add({path:t,caseSensitive:e,handler:n}),this.recognizer.add({path:`${t}/*au$residue`,caseSensitive:e,handler:n})}resolveLazy(t){return this.moduleLoader.load(t,(e=>{let n,i;for(const t of e.items)if(t.isConstructable){const e=t.definitions.find(xe);void 0!==e&&("default"===t.key?n=e:void 0===i&&(i=e))}if(void 0===n){if(void 0===i)throw new Error(`${t} does not appear to be a component or CustomElement recognizable by Aurelia`);return i}return n}))}toString(){const t=this.childViewportAgents.map(String).join(",");return`RC(path:'${this.friendlyPath}',viewports:[${t}])`}printTree(){const t=[];for(let e=0;e<this.path.length;++e)t.push(`${" ".repeat(e)}${this.path[e]}`);return t.join("\n")}}function ye(t,e){throw e.error(t),t}function xe(t){return $.isType(t.Type)}class $e{constructor(t,e){this.route=t,this.residue=e}}let be=class{constructor(t,e){this.logger=t,this.ctx=e,this.name="default",this.usedBy="",this.default="",this.fallback="",this.noScope=!1,this.noLink=!1,this.noHistory=!1,this.stateful=!1,this.agent=void 0,this.controller=void 0,this.logger=t.scopeTo(`au-viewport<${e.friendlyPath}>`),this.logger.trace("constructor()")}hydrated(t){this.logger.trace("hydrated()"),this.controller=t,this.agent=this.ctx.registerViewport(this)}attaching(t,e,n){return this.logger.trace("attaching()"),this.agent.activateFromViewport(t,this.controller,n)}detaching(t,e,n){return this.logger.trace("detaching()"),this.agent.deactivateFromViewport(t,this.controller,n)}dispose(){this.logger.trace("dispose()"),this.ctx.unregisterViewport(this),this.agent.dispose(),this.agent=void 0}toString(){const t=[];for(const e of Se){const n=this[e];switch(typeof n){case"string":""!==n&&t.push(`${e}:'${n}'`);break;case"boolean":n&&t.push(`${e}:${n}`);break;default:t.push(`${e}:${String(n)}`)}}return`VP(ctx:'${this.ctx.friendlyPath}',${t.join(",")})`}};Q([P],be.prototype,"name",void 0),Q([P],be.prototype,"usedBy",void 0),Q([P],be.prototype,"default",void 0),Q([P],be.prototype,"fallback",void 0),Q([P],be.prototype,"noScope",void 0),Q([P],be.prototype,"noLink",void 0),Q([P],be.prototype,"noHistory",void 0),Q([P],be.prototype,"stateful",void 0),be=Q([R({name:"au-viewport"}),Z(0,n),Z(1,me)],be);const Se=["name","usedBy","default","fallback","noScope","noLink","noHistory","stateful"];let ke=class{constructor(t,e,n,i,r,s,o){this.target=t,this.el=e,this.router=n,this.events=i,this.delegator=r,this.ctx=s,this.locationMgr=o,this.attribute="href",this.active=!1,this.href=null,this.instructions=null,this.eventListener=null,this.navigationEndListener=null,this.onClick=t=>{null!==this.instructions&&(t.altKey||t.ctrlKey||t.shiftKey||t.metaKey||0!==t.button||(t.preventDefault(),this.router.load(this.instructions,{context:this.ctx})))},this.isEnabled=!e.hasAttribute("external")&&!e.hasAttribute("data-external")}binding(){this.isEnabled&&(this.eventListener=this.delegator.addEventListener(this.target,this.el,"click",this.onClick)),this.valueChanged(),this.navigationEndListener=this.events.subscribe("au:router:navigation-end",(t=>{this.valueChanged(),this.active=null!==this.instructions&&this.router.isActive(this.instructions,this.ctx)}))}attaching(){if(null!==this.ctx.allResolved)return this.ctx.allResolved.then((()=>{this.valueChanged()}))}unbinding(){this.isEnabled&&this.eventListener.dispose(),this.navigationEndListener.dispose()}valueChanged(){const t=this.router.options.useUrlFragmentHash;if(null!=this.route&&null===this.ctx.allResolved){const e=this.ctx.childRoutes.find((t=>t.id===this.route));if(void 0!==e){const n=this.ctx.node.computeAbsolutePath();let i=e.path[0];if("object"==typeof this.params&&null!==this.params){const t=Object.keys(this.params);for(const e of t){const t=this.params[e];null!=t&&String(t).length>0&&(i=i.replace(new RegExp(`[*:]${e}[?]?`),t))}}i=i.replace(/\/[*:][^/]+[?]/g,"").replace(/[*:][^/]+[?]\//g,""),this.href=n?i?`${t?"#":""}${[n,i].join("/")}`:`${t?"#":""}${n}`:`${t?"#":""}${i}`,this.instructions=this.router.createViewportInstructions(`${t?"#":""}${i}`,{context:this.ctx})}else this.instructions=this.router.createViewportInstructions("object"==typeof this.params&&null!==this.params?{component:this.route,params:this.params}:this.route,{context:this.ctx}),this.href=this.instructions.toUrl(this.router.options.useUrlFragmentHash)}else this.instructions=null,this.href=null;const e=$.for(this.el,{optional:!0});if(null!==e)e.viewModel[this.attribute]=this.instructions;else if(null===this.href)this.el.removeAttribute(this.attribute);else{const e=t?this.href:this.locationMgr.addBaseHref(this.href);this.el.setAttribute(this.attribute,e)}}};Q([P({mode:E.toView,primary:!0,callback:"valueChanged"})],ke.prototype,"route",void 0),Q([P({mode:E.toView,callback:"valueChanged"})],ke.prototype,"params",void 0),Q([P({mode:E.toView})],ke.prototype,"attribute",void 0),Q([P({mode:E.fromView})],ke.prototype,"active",void 0),ke=Q([A("load"),Z(0,N),Z(1,I),Z(2,te),Z(3,tt),Z(4,U),Z(5,me),Z(6,ht)],ke);let Ce=class{constructor(t,e,n,i,r,s){if(this.target=t,this.el=e,this.router=n,this.delegator=i,this.ctx=r,this.isInitialized=!1,this.onClick=t=>{if(t.altKey||t.ctrlKey||t.shiftKey||t.metaKey||0!==t.button||this.isExternal||!this.isEnabled)return;const e=this.el.getAttribute("href");null!==e&&(t.preventDefault(),this.router.load(e,{context:this.ctx}))},n.options.useHref&&"A"===e.nodeName)switch(e.getAttribute("target")){case null:case s.name:case"_self":this.isEnabled=!0;break;default:this.isEnabled=!1}else this.isEnabled=!1}get isExternal(){return this.el.hasAttribute("external")||this.el.hasAttribute("data-external")}binding(){this.isInitialized||(this.isInitialized=!0,this.isEnabled=this.isEnabled&&null===L(this.el,O.getDefinition(ke).key)),this.isEnabled&&this.el.setAttribute("href",this.value),this.eventListener=this.delegator.addEventListener(this.target,this.el,"click",this.onClick)}unbinding(){this.eventListener.dispose()}valueChanged(t){this.el.setAttribute("href",t)}};Q([P({mode:E.toView})],Ce.prototype,"value",void 0),Ce=Q([A({name:"href",noMultiBindings:!0}),Z(0,N),Z(1,I),Z(2,te),Z(3,U),Z(4,me),Z(5,y)],Ce);const Te=te,Pe=[Te],Re=be,Ee=ke,Ae=Ce,Ne=[be,ke,Ce];function Ie(t,e){return t.register(j.hydrated(a,we.setRoot),j.afterActivate(te,(t=>o(e)?"function"==typeof e?e(t):t.start(e,!0):t.start({},!0))),j.afterDeactivate(te,(t=>{t.stop()})),...Pe,...Ne)}const Ue={register:t=>Ie(t),customize:t=>({register:e=>Ie(e,t)})};class Le{constructor(t){this.el=t,this.top=t.scrollTop,this.left=t.scrollLeft}static has(t){return t.scrollTop>0||t.scrollLeft>0}restore(){this.el.scrollTo(this.left,this.top),this.el=null}}function Oe(t){t.restore()}class je{constructor(t){this.scrollStates=[],this.save(t.children)}save(t){let e;for(let n=0,i=t.length;n<i;++n)e=t[n],Le.has(e)&&this.scrollStates.push(new Le(e)),this.save(e.children)}restore(){this.scrollStates.forEach(Oe),this.scrollStates=null}}const Ve=t.createInterface("IStateManager",(t=>t.singleton(He)));class He{constructor(){this.cache=new WeakMap}saveState(t){this.cache.set(t.host,new je(t.host))}restoreState(t){const e=this.cache.get(t.host);void 0!==e&&(e.restore(),this.cache.delete(t.host))}}export{Ot as AST,Nt as ActionExpression,Bt as AuNavId,ue as ChildRouteConfig,ve as ComponentAgent,At as ComponentExpression,Tt as CompositeSegmentExpression,Pe as DefaultComponents,Ne as DefaultResources,bt as ExpressionKind,Ce as HrefCustomAttribute,Ae as HrefCustomAttributeRegistration,at as IBaseHrefProvider,ht as ILocationManager,me as IRouteContext,te as IRouter,tt as IRouterEvents,Ve as IStateManager,ne as IViewportInstruction,ke as LoadCustomAttribute,Ee as LoadCustomAttributeRegistration,nt as LocationChangeEvent,Zt as Navigation,st as NavigationCancelEvent,rt as NavigationEndEvent,ot as NavigationErrorEvent,Qt as NavigationOptions,it as NavigationStartEvent,Lt as ParameterExpression,Ut as ParameterListExpression,de as Route,he as RouteConfig,we as RouteContext,ge as RouteDefinition,Ct as RouteExpression,Vt as RouteNode,Ht as RouteTree,ee as Router,Ue as RouterConfiguration,Jt as RouterOptions,Te as RouterRegistration,Pt as ScopedSegmentExpression,Et as SegmentExpression,Rt as SegmentGroupExpression,Xt as Transition,ft as ViewportAgent,be as ViewportCustomElement,Re as ViewportCustomElementRegistration,It as ViewportExpression,Yt as isManagedState,pe as route,Kt as toManagedState};
