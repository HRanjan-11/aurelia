import{IPlatform as t,ILogger as e,Registration as r}from"../../../kernel/dist/native-modules/index.js";import{IWindow as s,Controller as i}from"../../../runtime-html/dist/native-modules/index.js";import{BehaviorSubject as o,Subscription as n,Observable as a}from"rxjs";import{skip as c,take as l,delay as u}from"rxjs/operators/index.js";function p(t,e){if(!f(t))throw Error("Provided state is not of type StateHistory");return e>0?function(t,e){if(e<0||e>=t.future.length)return t;const{past:r,future:s,present:i}=t,o=[...r,i,...s.slice(0,e)],n=s[e],a=s.slice(e+1);return{past:o,present:n,future:a}}(t,e-1):e<0?function(t,e){if(e<0||e>=t.past.length)return t;const{past:r,future:s,present:i}=t,o=r.slice(0,e),n=[...r.slice(e+1),i,...s];return{past:o,present:r[e],future:n}}(t,t.past.length+e):t}function h(t,e){return{...t,past:[...t.past,t.present],present:e,future:[]}}function d(t,e){return f(t)&&(t.past.length>e&&(t.past=t.past.slice(t.past.length-e)),t.future.length>e&&(t.future=t.future.slice(0,e))),t}function f(t){return void 0!==t.present&&void 0!==t.future&&void 0!==t.past&&Array.isArray(t.future)&&Array.isArray(t.past)}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function g(t,e){return function(r,s){e(r,s,t)}}const m="aurelia-store-state";var y,v,w;function T(e,r,s){const i=E.container.get(t).console;i[void 0!==(null==s?void 0:s.logType)&&void 0!==i[s.logType]?s.logType:"log"]("New state: ",e)}function b(t,e,r){const i=E.container.get(s).localStorage;if(void 0!==i){i.setItem(void 0!==(null==r?void 0:r.key)?r.key:"aurelia-store-state",JSON.stringify(t))}}function S(t,e){const r=E.container.get(s).localStorage;if(void 0===r)return t;const i=r.getItem(void 0===e?"aurelia-store-state":e);if(null===i||""===i)return t;try{return JSON.parse(i)}catch(t){}return t}function A(t,e,r){var s;return(null===(s=t.logDefinitions)||void 0===s?void 0:s.hasOwnProperty(e))&&t.logDefinitions[e]&&Object.values(v).includes(t.logDefinitions[e])?t.logDefinitions[e]:r}!function(t){t.Before="before",t.After="after"}(y||(y={})),function(t){t.trace="trace",t.debug="debug",t.info="info",t.warn="warn",t.error="error"}(v||(v={})),function(t){t.StartEnd="startEnd",t.All="all"}(w||(w={}));const E={container:null};class O extends Error{constructor(t){super(`Tried to dispatch an unregistered action ${void 0!==t&&("string"==typeof t?t:t.name)}`)}}class _ extends Error{}class D extends Error{}class M extends Error{}let j=class{constructor(t,e,r,s){var i,n,a,c;this.initialState=t,this.logger=e,this.window=r,this.devToolsAvailable=!1,this.actions=new Map,this.middlewares=new Map,this.dispatchQueue=[],this.options=null!=s?s:{};const l=!0===(null===(n=null===(i=this.options)||void 0===i?void 0:i.history)||void 0===n?void 0:n.undoable);this._state=new o(t),this.state=this._state.asObservable(),!0!==(null===(c=null===(a=this.options)||void 0===a?void 0:a.devToolsOptions)||void 0===c?void 0:c.disable)&&this.setupDevTools(),l&&this.registerHistoryMethods()}registerMiddleware(t,e,r){this.middlewares.set(t,{placement:e,settings:r})}unregisterMiddleware(t){this.middlewares.has(t)&&this.middlewares.delete(t)}isMiddlewareRegistered(t){return this.middlewares.has(t)}registerAction(t,e){if(0===e.length)throw new D("The reducer is expected to have one or more parameters, where the first will be the present state");this.actions.set(e,{type:t})}unregisterAction(t){this.actions.has(t)&&this.actions.delete(t)}isActionRegistered(t){return"string"==typeof t?void 0!==Array.from(this.actions).find((e=>e[1].type===t)):this.actions.has(t)}resetToState(t){this._state.next(t)}async dispatch(t,...e){const r=this.lookupAction(t);return r?this.queueDispatch([{reducer:r,params:e}]):Promise.reject(new O(t))}pipe(t,...e){const r=[],s={dispatch:async()=>this.queueDispatch(r),pipe:(e,...i)=>{const o=this.lookupAction(e);if(!o)throw new O(t);return r.push({reducer:o,params:i}),s}};return s.pipe(t,...e)}lookupAction(t){if("string"==typeof t){const e=Array.from(this.actions).find((([e,r])=>r.type===t));if(e)return e[0]}else if(this.actions.has(t))return t}async queueDispatch(t){return new Promise(((e,r)=>{this.dispatchQueue.push({actions:t,resolve:e,reject:r}),1===this.dispatchQueue.length&&this.handleQueue()}))}async handleQueue(){if(this.dispatchQueue.length>0){const t=this.dispatchQueue[0];try{await this.internalDispatch(t.actions),t.resolve()}catch(e){t.reject(e)}this.dispatchQueue.shift(),this.handleQueue()}}async internalDispatch(t){var e;const r=t.find((t=>!this.actions.has(t.reducer)));if(r)throw new O(r.reducer);E.container.get(s).performance.mark("dispatch-start");const i=t.map((t=>({type:this.actions.get(t.reducer).type,params:t.params,reducer:t.reducer}))),o={name:i.map((t=>t.type)).join("->"),params:i.reduce(((t,e)=>t.concat(e.params)),[]),pipedActions:i.map((t=>({name:t.type,params:t.params})))};this.options.logDispatchedActions&&this.logger[A(this.options,"dispatchedActions",v.info)](`Dispatching: ${o.name}`);const n=await this.executeMiddlewares(this._state.getValue(),y.Before,o);if(!1===n)return E.container.get(s).performance.clearMarks(),void E.container.get(s).performance.clearMeasures();let a=n;for(const t of i){if(a=await t.reducer(a,...t.params),!1===a)return E.container.get(s).performance.clearMarks(),void E.container.get(s).performance.clearMeasures();if(E.container.get(s).performance.mark(`dispatch-after-reducer-${t.type}`),!a&&"object"!=typeof a)throw new M("The reducer has to return a new state")}let c=await this.executeMiddlewares(a,y.After,o);if(!1===c)return E.container.get(s).performance.clearMarks(),void E.container.get(s).performance.clearMeasures();if(f(c)&&(null===(e=this.options.history)||void 0===e?void 0:e.limit)&&(c=d(c,this.options.history.limit)),this._state.next(c),E.container.get(s).performance.mark("dispatch-end"),this.options.measurePerformance===w.StartEnd){E.container.get(s).performance.measure("startEndDispatchDuration","dispatch-start","dispatch-end");const t=E.container.get(s).performance.getEntriesByName("startEndDispatchDuration");this.logger[A(this.options,"performanceLog",v.info)](`Total duration ${t[0].duration} of dispatched action ${o.name}:`,t)}else if(this.options.measurePerformance===w.All){const t=E.container.get(s).performance.getEntriesByType("mark"),e=t[t.length-1].startTime-t[0].startTime;this.logger[A(this.options,"performanceLog",v.info)](`Total duration ${e} of dispatched action ${o.name}:`,t)}E.container.get(s).performance.clearMarks(),E.container.get(s).performance.clearMeasures(),this.updateDevToolsState({type:o.name,params:o.params},c)}executeMiddlewares(t,e,r){return Array.from(this.middlewares).filter((t=>t[1].placement===e)).reduce((async(t,i,o)=>{try{const o=await i[0](await t,this._state.getValue(),i[1].settings,r);return!1!==o&&(o||await t)}catch(e){if(this.options.propagateError)throw e;return await t}finally{E.container.get(s).performance.mark(`dispatch-${e}-${i[0].name}`)}}),t)}setupDevTools(){this.window.__REDUX_DEVTOOLS_EXTENSION__&&(this.logger[A(this.options,"devToolsStatus",v.debug)]("DevTools are available"),this.devToolsAvailable=!0,this.devTools=this.window.__REDUX_DEVTOOLS_EXTENSION__.connect(this.options.devToolsOptions),this.devTools.init(this.initialState),this.devTools.subscribe((t=>{var e,r;if(this.logger[A(this.options,"devToolsStatus",v.debug)](`DevTools sent change ${t.type}`),"ACTION"!==t.type||void 0===t.payload){if("DISPATCH"===t.type&&t.payload)switch(t.payload.type){case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return void this._state.next(JSON.parse(t.state));case"COMMIT":return void this.devTools.init(this._state.getValue());case"RESET":return this.devTools.init(this.initialState),void this.resetToState(this.initialState);case"ROLLBACK":{const e=JSON.parse(t.state);return this.resetToState(e),void this.devTools.init(e)}}}else{const s=Array.from(this.actions).find((function([e]){var r;return e.name===(null===(r=t.payload)||void 0===r?void 0:r.name)})),i=null!==(r=this.lookupAction(null===(e=t.payload)||void 0===e?void 0:e.name))&&void 0!==r?r:null==s?void 0:s[0];if(!i)throw new _("Tried to remotely dispatch an unregistered action");if(!t.payload.args||t.payload.args.length<1)throw new _("No action arguments provided");this.dispatch(i,...t.payload.args.slice(1).map((t=>JSON.parse(t)))).catch((()=>{throw new _("Issue when trying to dispatch an action through devtools")}))}})))}updateDevToolsState(t,e){this.devToolsAvailable&&this.devTools&&this.devTools.send(t,e)}registerHistoryMethods(){this.registerAction("jump",p)}};function k(t){const e=E.container.get(j);return async function(...r){return e.dispatch(t,...r)}}j=function(t,e,r,s){var i,o=arguments.length,n=o<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,r,s);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(n=(o<3?i(n):o>3?i(e,r,n):i(e,r))||n);return o>3&&n&&Object.defineProperty(e,r,n),n}([g(1,e),g(2,s)],j);const x=c,N=l,C=u;async function P(t,e,...r){const s=(t,r)=>s=>{e&&(console.group(`Step ${r}`),console.log(s),console.groupEnd()),t(s)},i=(t,e)=>r=>{try{t(r)}catch(t){e(t)}};return new Promise(((e,o)=>{let n=0;r.slice(0,-1).forEach((e=>{t.state.pipe(x(n),N(1),C(0)).subscribe(i(s(e,n),o)),n++})),t.state.pipe(x(n),N(1)).subscribe(((t,e)=>r=>{t(r),e()})(i(s(r[r.length-1],n),o),e))}))}const R=t=>t.state;function $(t){const e={selector:"function"==typeof t?t:R,...t};function r(t,e){const r=e(t);return r instanceof a?r:t.state}function s(){const t="object"==typeof e.selector;return Object.entries({...t?e.selector:{[e.target||"state"]:e.selector||R}}).map((([r,s])=>({targets:e.target&&t?[e.target,r]:[r],selector:s,changeHandlers:{[e.onChanged||""]:1,[`${e.target||r}Changed`]:e.target?0:1,propertyChanged:0}})))}return function(e){const o="object"==typeof t&&t.setup?e.prototype[t.setup]:e.prototype.binding,a="object"==typeof t&&t.teardown?e.prototype[t.teardown]:e.prototype.bound;e.prototype["object"==typeof t&&void 0!==t.setup?t.setup:"binding"]=function(){if("object"==typeof t&&"string"==typeof t.onChanged&&!(t.onChanged in this))throw new Error("Provided onChanged handler does not exist on target VM");const e=i.getCached(this)?i.getCached(this).container.get(j):E.container.get(j);if(this._stateSubscriptions=s().map((t=>r(e,t.selector).subscribe((e=>{const r=t.targets.length-1,s=t.targets.reduce(((t={},e)=>t[e]),this);Object.entries(t.changeHandlers).forEach((([i,o])=>{i in this&&this[i](...[t.targets[r],e,s].slice(o,3))})),t.targets.reduce(((t,s,i)=>(t[s]=i===r?e:t[s]||{},t[s])),this)})))),o)return o.apply(this,arguments)},e.prototype["object"==typeof t&&t.teardown?t.teardown:"bound"]=function(){if(this._stateSubscriptions&&Array.isArray(this._stateSubscriptions)&&this._stateSubscriptions.forEach((t=>{t instanceof n&&!1===t.closed&&t.unsubscribe()})),a)return a.apply(this,arguments)}}}const I={withInitialState(t){return Reflect.set(this,"state",t),this},withOptions(t){return Reflect.set(this,"options",t),this},register(t){var i;E.container=t;const o=Reflect.get(this,"state"),n=Reflect.get(this,"options"),a=t.get(e),c=t.get(s);if(!o)throw new Error("initialState must be provided via withInitialState builder method");let l=o;return(null===(i=null==n?void 0:n.history)||void 0===i?void 0:i.undoable)&&!f(o)&&(l={past:[],present:o,future:[]}),r.instance(j,new j(l,a,c,n)).register(t),t}};export{D as ActionRegistrationError,m as DEFAULT_LOCAL_STORAGE_KEY,_ as DevToolsRemoteDispatchError,v as LogLevel,y as MiddlewarePlacement,w as PerformanceMeasurement,M as ReducerNoStateError,E as STORE,j as Store,I as StoreConfiguration,O as UnregisteredActionError,d as applyLimits,$ as connectTo,k as dispatchify,P as executeSteps,A as getLogType,f as isStateHistory,p as jump,b as localStorageMiddleware,T as logMiddleware,h as nextStateHistory,S as rehydrateFromLocalStorage};
